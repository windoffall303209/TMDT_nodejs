<%- include('../partials/header') %>

<div class="checkout-page" style="padding: 40px 0; background: #f5f5f5; min-height: 80vh;">
    <div class="container">
        <h1 style="margin: 0 0 30px 0; font-size: 28px; font-weight: 700; color: #333;">üõí Thanh To√°n</h1>
        
        <% if (!cart || !cart.items || cart.items.length === 0) { %>
            <div style="text-align: center; padding: 60px; background: white; border-radius: 12px;">
                <span style="font-size: 64px;">üõí</span>
                <h3 style="margin: 20px 0 10px 0; color: #333;">Gi·ªè h√†ng tr·ªëng</h3>
                <p style="color: #666;">Vui l√≤ng th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng tr∆∞·ªõc khi thanh to√°n.</p>
                <a href="/products" style="display: inline-block; margin-top: 20px; padding: 14px 28px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">Ti·∫øp t·ª•c mua s·∫Øm</a>
            </div>
        <% } else { %>
        
        <form action="/orders/create" method="POST" id="checkoutForm">
            <div style="display: grid; grid-template-columns: 1fr 400px; gap: 30px;">
                
                <!-- Left Column - Address & Payment -->
                <div>
                    <!-- Shipping Address -->
                    <div style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #333; display: flex; align-items: center; gap: 10px;">
                            üìç ƒê·ªãa Ch·ªâ Giao H√†ng
                        </h3>
                        
                        <% if (addresses && addresses.length > 0) { %>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <% addresses.forEach((addr, index) => { %>
                                    <label style="display: flex; align-items: flex-start; gap: 12px; padding: 15px; border: 2px solid <%= addr.is_default ? '#667eea' : '#e0e0e0' %>; border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                                        <input type="radio" name="address_id" value="<%= addr.id %>" <%= addr.is_default ? 'checked' : '' %> required style="margin-top: 3px;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #333;"><%= addr.full_name %> - <%= addr.phone %></div>
                                            <div style="color: #666; margin-top: 5px; font-size: 14px;">
                                                <%= addr.address_line %><%= addr.ward ? ', ' + addr.ward : '' %><%= addr.district ? ', ' + addr.district : '' %>, <%= addr.city %>
                                            </div>
                                            <% if (addr.is_default) { %>
                                                <span style="display: inline-block; margin-top: 8px; padding: 3px 10px; background: #e8f5e9; color: #2e7d32; font-size: 12px; border-radius: 4px;">M·∫∑c ƒë·ªãnh</span>
                                            <% } %>
                                        </div>
                                    </label>
                                <% }) %>
                            </div>
                            <button type="button" onclick="toggleAddressForm()" style="margin-top: 15px; padding: 10px 20px; background: #f0f0f0; color: #333; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                ‚ûï Th√™m ƒë·ªãa ch·ªâ m·ªõi
                            </button>
                        <% } else { %>
                            <p style="color: #666; margin-bottom: 15px;">B·∫°n ch∆∞a c√≥ ƒë·ªãa ch·ªâ giao h√†ng. Vui l√≤ng th√™m ƒë·ªãa ch·ªâ m·ªõi.</p>
                        <% } %>
                        
                        <!-- New Address Form -->
                        <div id="newAddressForm" style="display: <%= (!addresses || addresses.length === 0) ? 'block' : 'none' %>; margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 10px;">
                            <h4 style="margin: 0 0 15px 0; font-size: 16px; color: #333;">Th√™m ƒë·ªãa ch·ªâ m·ªõi</h4>
                            <div style="display: grid; gap: 15px; grid-template-columns: 1fr 1fr;">
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">H·ªç t√™n*</label>
                                    <input type="text" id="newFullName" placeholder="Nguy·ªÖn VƒÉn A" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">S·ªë ƒëi·ªán tho·∫°i*</label>
                                    <input type="tel" id="newPhone" placeholder="0901234567" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            <div style="margin-top: 15px;">
                                <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">ƒê·ªãa ch·ªâ chi ti·∫øt*</label>
                                <input type="text" id="newAddressLine" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="display: grid; gap: 15px; grid-template-columns: 1fr 1fr 1fr; margin-top: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">Ph∆∞·ªùng/X√£</label>
                                    <input type="text" id="newWard" placeholder="Ph∆∞·ªùng 1" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">Qu·∫≠n/Huy·ªán</label>
                                    <input type="text" id="newDistrict" placeholder="Qu·∫≠n 1" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">T·ªânh/Th√†nh ph·ªë*</label>
                                    <input type="text" id="newCity" placeholder="TP. H·ªì Ch√≠ Minh" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            <button type="button" onclick="saveNewAddress()" style="margin-top: 20px; padding: 12px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                L∆∞u ƒë·ªãa ch·ªâ
                            </button>
                        </div>
                    </div>
                    
                    <!-- Payment Method -->
                    <div style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #333; display: flex; align-items: center; gap: 10px;">
                            üí≥ Ph∆∞∆°ng Th·ª©c Thanh To√°n
                        </h3>
                        
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid #667eea; border-radius: 10px; cursor: pointer;">
                                <input type="radio" name="payment_method" value="cod" checked required>
                                <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                    <span style="font-size: 24px;">üíµ</span>
                                    <div>
                                        <div style="font-weight: 600; color: #333;">Thanh to√°n khi nh·∫≠n h√†ng (COD)</div>
                                        <div style="color: #666; font-size: 13px;">Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer;">
                                <input type="radio" name="payment_method" value="vnpay">
                                <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                    <span style="font-size: 24px;">üè¶</span>
                                    <div>
                                        <div style="font-weight: 600; color: #333;">VNPay</div>
                                        <div style="color: #666; font-size: 13px;">Thanh to√°n qua ng√¢n h√†ng, th·∫ª ATM, Visa/Master</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer;">
                                <input type="radio" name="payment_method" value="momo">
                                <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                    <span style="font-size: 24px;">üì±</span>
                                    <div>
                                        <div style="font-weight: 600; color: #333;">V√≠ MoMo</div>
                                        <div style="color: #666; font-size: 13px;">Qu√©t m√£ QR thanh to√°n qua v√≠ MoMo</div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #333;">üìù Ghi ch√∫</h3>
                        <textarea name="notes" rows="3" placeholder="Ghi ch√∫ cho ƒë∆°n h√†ng (kh√¥ng b·∫Øt bu·ªôc)..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                    </div>
                </div>
                
                <!-- Right Column - Order Summary -->
                <div>
                    <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 20px;">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #333;">üì¶ ƒê∆°n H√†ng (<%= cart.items.length %> s·∫£n ph·∫©m)</h3>
                        
                        <div style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                            <% cart.items.forEach(item => { %>
                                <div style="display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid #f0f0f0;">
                                    <div style="width: 60px; height: 60px; border-radius: 8px; overflow: hidden; background: #f5f5f5; flex-shrink: 0;">
                                        <% if (item.product_image) { %>
                                            <img src="<%= item.product_image %>" alt="<%= item.product_name %>" style="width: 100%; height: 100%; object-fit: cover;">
                                        <% } else { %>
                                            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">üëï</div>
                                        <% } %>
                                    </div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 500; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"><%= item.product_name %></div>
                                        <div style="color: #666; font-size: 13px; margin-top: 3px;">SL: <%= item.quantity %></div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 600; color: #d32f2f;"><%= item.subtotal.toLocaleString('vi-VN') %>ƒë</div>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                        
                        <div style="border-top: 2px solid #f0f0f0; padding-top: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #666;">T·∫°m t√≠nh:</span>
                                <span style="font-weight: 500;"><%= cart.subtotal.toLocaleString('vi-VN') %>ƒë</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #666;">Ph√≠ v·∫≠n chuy·ªÉn:</span>
                                <% const shippingFee = cart.subtotal >= 500000 ? 0 : 30000; %>
                                <span style="font-weight: 500; color: <%= shippingFee === 0 ? '#2e7d32' : '#333' %>;"><%= shippingFee === 0 ? 'Mi·ªÖn ph√≠' : shippingFee.toLocaleString('vi-VN') + 'ƒë' %></span>
                            </div>
                            <% if (cart.subtotal < 500000) { %>
                                <div style="background: #fff3e0; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                                    <p style="margin: 0; font-size: 13px; color: #e65100;">üí° Mua th√™m <%= (500000 - cart.subtotal).toLocaleString('vi-VN') %>ƒë ƒë·ªÉ ƒë∆∞·ª£c mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn!</p>
                                </div>
                            <% } %>
                            
                            <!-- Voucher/Promo Code Input -->
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="voucherCode" name="voucher_code" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°" style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                    <button type="button" onclick="applyVoucher()" style="padding: 12px 20px; background: #4caf50; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">√Åp d·ª•ng</button>
                                </div>
                                <div id="voucherMessage" style="margin-top: 8px; font-size: 13px;"></div>
                            </div>
                            
                            <!-- Discount Row (hidden by default) -->
                            <div id="discountRow" style="display: none; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #2e7d32;">Gi·∫£m gi√°:</span>
                                <span id="discountAmount" style="font-weight: 500; color: #2e7d32;">-0ƒë</span>
                            </div>
                            
                            <!-- Hidden fields for backend -->
                            <input type="hidden" name="shipping_fee" id="shippingFeeInput" value="<%= shippingFee %>">
                            <input type="hidden" name="discount_amount" id="discountInput" value="0">
                            <input type="hidden" name="subtotal" value="<%= cart.subtotal %>">
                            
                            <div style="display: flex; justify-content: space-between; padding-top: 15px; border-top: 2px solid #333;">
                                <span style="font-size: 18px; font-weight: 600; color: #333;">T·ªïng c·ªông:</span>
                                <span id="totalAmount" style="font-size: 22px; font-weight: 700; color: #d32f2f;"><%= (cart.subtotal + shippingFee).toLocaleString('vi-VN') %>ƒë</span>
                            </div>
                        </div>
                        
                        <button type="submit" id="submitBtn" style="width: 100%; margin-top: 25px; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: 700; cursor: pointer; transition: transform 0.2s;">
                            ‚ú® ƒê·∫∑t H√†ng
                        </button>
                        
                        <p style="text-align: center; margin-top: 15px; color: #666; font-size: 13px;">
                            B·∫±ng vi·ªác ƒë·∫∑t h√†ng, b·∫°n ƒë·ªìng √Ω v·ªõi <a href="#" style="color: #667eea;">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a>
                        </p>
                    </div>
                </div>
            </div>
        </form>
        
        <% } %>
    </div>
</div>

<script src="/js/main.js"></script>
<script>
function toggleAddressForm() {
    const form = document.getElementById('newAddressForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

async function saveNewAddress() {
    const fullName = document.getElementById('newFullName').value;
    const phone = document.getElementById('newPhone').value;
    const addressLine = document.getElementById('newAddressLine').value;
    const ward = document.getElementById('newWard').value;
    const district = document.getElementById('newDistrict').value;
    const city = document.getElementById('newCity').value;
    
    if (!fullName || !phone || !addressLine || !city) {
        alert('‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
        return;
    }
    
    try {
        const response = await fetch('/auth/address', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({
                full_name: fullName,
                phone: phone,
                address_line: addressLine,
                ward: ward,
                district: district,
                city: city,
                is_default: true
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ ƒê√£ l∆∞u ƒë·ªãa ch·ªâ th√†nh c√¥ng!');
            location.reload();
        } else {
            alert('‚ùå ' + (data.message || 'C√≥ l·ªói x·∫£y ra'));
        }
    } catch (error) {
        console.error('Save address error:', error);
        alert('‚ùå C√≥ l·ªói x·∫£y ra khi l∆∞u ƒë·ªãa ch·ªâ');
    }
}

// Handle payment method selection styling
document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.querySelectorAll('input[name="payment_method"]').forEach(r => {
            r.closest('label').style.borderColor = '#e0e0e0';
        });
        this.closest('label').style.borderColor = '#667eea';
    });
});

// Handle address selection styling
document.querySelectorAll('input[name="address_id"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.querySelectorAll('input[name="address_id"]').forEach(r => {
            r.closest('label').style.borderColor = '#e0e0e0';
        });
        this.closest('label').style.borderColor = '#667eea';
    });
});

// Form validation
document.getElementById('checkoutForm')?.addEventListener('submit', function(e) {
    const addressSelected = document.querySelector('input[name="address_id"]:checked');
    if (!addressSelected) {
        e.preventDefault();
        alert('Vui l√≤ng ch·ªçn ho·∫∑c th√™m ƒë·ªãa ch·ªâ giao h√†ng');
        return;
    }
    
    // Show loading
    const btn = document.getElementById('submitBtn');
    btn.textContent = 'ƒêang x·ª≠ l√Ω...';
    btn.disabled = true;
});

// Voucher system
const checkoutSubtotal = <%= cart.subtotal %>;
const checkoutShippingFee = checkoutSubtotal >= 500000 ? 0 : 30000;
let currentDiscount = 0;

// Sample voucher codes (in real app, this would be validated on server)
const validVouchers = {
    'GIAM10': { type: 'percent', value: 10, maxDiscount: 100000, minOrder: 200000 },
    'GIAM20': { type: 'percent', value: 20, maxDiscount: 200000, minOrder: 500000 },
    'FREESHIP': { type: 'fixed', value: checkoutShippingFee, minOrder: 0 },
    'VIP50K': { type: 'fixed', value: 50000, minOrder: 300000 }
};

function applyVoucher() {
    const code = document.getElementById('voucherCode').value.toUpperCase().trim();
    const messageEl = document.getElementById('voucherMessage');
    const discountRowEl = document.getElementById('discountRow');
    const discountAmountEl = document.getElementById('discountAmount');
    const discountInput = document.getElementById('discountInput');
    const totalEl = document.getElementById('totalAmount');
    
    if (!code) {
        messageEl.innerHTML = '<span style="color: #f44336;">Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°</span>';
        return;
    }
    
    const voucher = validVouchers[code];
    
    if (!voucher) {
        messageEl.innerHTML = '<span style="color: #f44336;">M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá</span>';
        currentDiscount = 0;
    } else if (checkoutSubtotal < voucher.minOrder) {
        messageEl.innerHTML = '<span style="color: #f44336;">ƒê∆°n h√†ng t·ªëi thi·ªÉu ' + voucher.minOrder.toLocaleString('vi-VN') + 'ƒë ƒë·ªÉ s·ª≠ d·ª•ng m√£ n√†y</span>';
        currentDiscount = 0;
    } else {
        // Calculate discount
        if (voucher.type === 'percent') {
            currentDiscount = Math.floor(checkoutSubtotal * voucher.value / 100);
            if (voucher.maxDiscount && currentDiscount > voucher.maxDiscount) {
                currentDiscount = voucher.maxDiscount;
            }
        } else {
            currentDiscount = voucher.value;
        }
        
        messageEl.innerHTML = '<span style="color: #2e7d32;">‚úÖ √Åp d·ª•ng th√†nh c√¥ng! Gi·∫£m ' + currentDiscount.toLocaleString('vi-VN') + 'ƒë</span>';
    }
    
    // Update UI
    if (currentDiscount > 0) {
        discountRowEl.style.display = 'flex';
        discountAmountEl.textContent = '-' + currentDiscount.toLocaleString('vi-VN') + 'ƒë';
    } else {
        discountRowEl.style.display = 'none';
    }
    
    // Update hidden input
    discountInput.value = currentDiscount;
    
    // Update total
    const total = checkoutSubtotal + checkoutShippingFee - currentDiscount;
    totalEl.textContent = total.toLocaleString('vi-VN') + 'ƒë';
}
</script>

<%- include('../partials/footer') %>

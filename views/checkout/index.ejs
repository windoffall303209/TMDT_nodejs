<%- include('../partials/header') %>

<!-- Load Checkout CSS -->
<link rel="stylesheet" href="/css/checkout.css">

<div class="checkout-page">
    <div class="container">
        <h1 class="checkout-page__title">üõí Thanh To√°n</h1>
        
        <% if (!cart || !cart.items || cart.items.length === 0) { %>
            <div class="checkout-empty">
                <span class="checkout-empty__icon">üõí</span>
                <h3 class="checkout-empty__title">Gi·ªè h√†ng tr·ªëng</h3>
                <p class="checkout-empty__text">Vui l√≤ng th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng tr∆∞·ªõc khi thanh to√°n.</p>
                <a href="/products" class="checkout-empty__btn">Ti·∫øp t·ª•c mua s·∫Øm</a>
            </div>
        <% } else { %>
        
        <form action="/orders/create" method="POST" id="checkoutForm">
            <div class="checkout-grid">
                
                <!-- Left Column - Address & Payment -->
                <div>
                    <!-- Shipping Address -->
                    <div class="checkout-section">
                        <h3 class="checkout-section__title">üìç ƒê·ªãa Ch·ªâ Giao H√†ng</h3>
                        
                        <% if (addresses && addresses.length > 0) { %>
                            <div class="address-list">
                                <% addresses.forEach((addr, index) => { %>
                                    <label class="address-card <%= addr.is_default ? 'address-card--selected' : '' %>">
                                        <input type="radio" name="address_id" value="<%= addr.id %>" <%= addr.is_default ? 'checked' : '' %> required class="address-card__radio">
                                        <div class="address-card__content">
                                            <div class="address-card__name"><%= addr.full_name %> - <%= addr.phone %></div>
                                            <div class="address-card__detail">
                                                <%= addr.address_line %><%= addr.ward ? ', ' + addr.ward : '' %><%= addr.district ? ', ' + addr.district : '' %>, <%= addr.city %>
                                            </div>
                                            <% if (addr.is_default) { %>
                                                <span class="address-card__badge">M·∫∑c ƒë·ªãnh</span>
                                            <% } %>
                                        </div>
                                    </label>
                                <% }) %>
                            </div>
                            <button type="button" onclick="toggleAddressForm()" class="address-add-btn">
                                ‚ûï Th√™m ƒë·ªãa ch·ªâ m·ªõi
                            </button>
                        <% } else { %>
                            <p class="checkout-section__text">B·∫°n ch∆∞a c√≥ ƒë·ªãa ch·ªâ giao h√†ng. Vui l√≤ng th√™m ƒë·ªãa ch·ªâ m·ªõi.</p>
                        <% } %>
                        
                        <!-- New Address Form -->
                        <div id="newAddressForm" class="address-form" style="display: <%= (!addresses || addresses.length === 0) ? 'block' : 'none' %>;">
                            <h4 class="address-form__title">Th√™m ƒë·ªãa ch·ªâ m·ªõi</h4>
                            <div class="address-form__grid">
                                <div>
                                    <label class="address-form__label">H·ªç t√™n*</label>
                                    <input type="text" id="newFullName" placeholder="Nguy·ªÖn VƒÉn A" class="address-form__input">
                                </div>
                                <div>
                                    <label class="address-form__label">S·ªë ƒëi·ªán tho·∫°i*</label>
                                    <input type="tel" id="newPhone" placeholder="0901234567" class="address-form__input">
                                </div>
                            </div>
                            <div class="address-form__field">
                                <label class="address-form__label">ƒê·ªãa ch·ªâ chi ti·∫øt*</label>
                                <input type="text" id="newAddressLine" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng..." class="address-form__input">
                            </div>
                            <div class="address-form__grid-3">
                                <div>
                                    <label class="address-form__label">Ph∆∞·ªùng/X√£</label>
                                    <input type="text" id="newWard" placeholder="Ph∆∞·ªùng 1" class="address-form__input">
                                </div>
                                <div>
                                    <label class="address-form__label">Qu·∫≠n/Huy·ªán</label>
                                    <input type="text" id="newDistrict" placeholder="Qu·∫≠n 1" class="address-form__input">
                                </div>
                                <div>
                                    <label class="address-form__label">T·ªânh/Th√†nh ph·ªë*</label>
                                    <input type="text" id="newCity" placeholder="TP. H·ªì Ch√≠ Minh" class="address-form__input">
                                </div>
                            </div>
                            <button type="button" onclick="saveNewAddress()" class="address-form__submit">
                                L∆∞u ƒë·ªãa ch·ªâ
                            </button>
                        </div>
                    </div>
                    
                    <!-- Payment Method -->
                    <div class="checkout-section">
                        <h3 class="checkout-section__title">üí≥ Ph∆∞∆°ng Th·ª©c Thanh To√°n</h3>
                        
                        <div class="payment-list">
                            <label class="payment-option payment-option--selected">
                                <input type="radio" name="payment_method" value="cod" checked required>
                                <div class="payment-option__content">
                                    <span class="payment-option__icon">üíµ</span>
                                    <div>
                                        <div class="payment-option__name">Thanh to√°n khi nh·∫≠n h√†ng (COD)</div>
                                        <div class="payment-option__desc">Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="vnpay">
                                <div class="payment-option__content">
                                    <span class="payment-option__icon">üè¶</span>
                                    <div>
                                        <div class="payment-option__name">VNPay</div>
                                        <div class="payment-option__desc">Thanh to√°n qua ng√¢n h√†ng, th·∫ª ATM, Visa/Master</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="momo">
                                <div class="payment-option__content">
                                    <span class="payment-option__icon">üì±</span>
                                    <div>
                                        <div class="payment-option__name">V√≠ MoMo</div>
                                        <div class="payment-option__desc">Qu√©t m√£ QR thanh to√°n qua v√≠ MoMo</div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="checkout-section">
                        <h3 class="checkout-notes__title">üìù Ghi ch√∫</h3>
                        <textarea name="notes" rows="3" placeholder="Ghi ch√∫ cho ƒë∆°n h√†ng (kh√¥ng b·∫Øt bu·ªôc)..." class="checkout-notes__textarea"></textarea>
                    </div>
                </div>
                
                <!-- Right Column - Order Summary -->
                <div>
                    <div class="order-summary">
                        <h3 class="order-summary__title">üì¶ ƒê∆°n H√†ng (<%= cart.items.length %> s·∫£n ph·∫©m)</h3>
                        
                        <div class="order-summary__items">
                            <% cart.items.forEach(item => { %>
                                <div class="order-summary__item">
                                    <div class="order-summary__item-image">
                                        <% if (item.product_image) { %>
                                            <img src="<%= item.product_image %>" alt="<%= item.product_name %>">
                                        <% } else { %>
                                            <div class="order-summary__item-placeholder">üëï</div>
                                        <% } %>
                                    </div>
                                    <div class="order-summary__item-info">
                                        <div class="order-summary__item-name"><%= item.product_name %></div>
                                        <div class="order-summary__item-qty">SL: <%= item.quantity %></div>
                                    </div>
                                    <div class="order-summary__item-price">
                                        <div class="order-summary__item-amount"><%= item.subtotal.toLocaleString('vi-VN') %>ƒë</div>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                        
                        <div class="order-summary__prices">
                            <div class="order-summary__row">
                                <span class="order-summary__label">T·∫°m t√≠nh:</span>
                                <span class="order-summary__value"><%= cart.subtotal.toLocaleString('vi-VN') %>ƒë</span>
                            </div>
                            <div class="order-summary__row">
                                <span class="order-summary__label">Ph√≠ v·∫≠n chuy·ªÉn:</span>
                                <% const shippingFee = cart.subtotal >= 500000 ? 0 : 30000; %>
                                <span class="order-summary__value <%= shippingFee === 0 ? 'order-summary__value--free' : '' %>"><%= shippingFee === 0 ? 'Mi·ªÖn ph√≠' : shippingFee.toLocaleString('vi-VN') + 'ƒë' %></span>
                            </div>
                            <% if (cart.subtotal < 500000) { %>
                                <div class="order-summary__shipping-tip">
                                    <p>üí° Mua th√™m <%= (500000 - cart.subtotal).toLocaleString('vi-VN') %>ƒë ƒë·ªÉ ƒë∆∞·ª£c mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn!</p>
                                </div>
                            <% } %>
                            
                            <!-- Voucher Section -->
                            <div class="voucher-section">
                                <div class="voucher-section__input-group">
                                    <input type="text" id="voucherCode" name="voucher_code" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°" class="voucher-section__input">
                                    <button type="button" onclick="applyVoucher()" class="voucher-section__btn">√Åp d·ª•ng</button>
                                </div>
                                <div id="voucherMessage" class="voucher-section__message"></div>
                            </div>
                            
                            <!-- Discount Row -->
                            <div id="discountRow" class="discount-row">
                                <span class="discount-row__label">Gi·∫£m gi√°:</span>
                                <span id="discountAmount" class="discount-row__value">-0ƒë</span>
                            </div>
                            
                            <!-- Hidden fields -->
                            <input type="hidden" name="shipping_fee" id="shippingFeeInput" value="<%= shippingFee %>">
                            <input type="hidden" name="discount_amount" id="discountInput" value="0">
                            <input type="hidden" name="subtotal" value="<%= cart.subtotal %>">
                            
                            <div class="order-summary__total">
                                <span class="order-summary__total-label">T·ªïng c·ªông:</span>
                                <span id="totalAmount" class="order-summary__total-value"><%= (cart.subtotal + shippingFee).toLocaleString('vi-VN') %>ƒë</span>
                            </div>
                        </div>
                        
                        <button type="submit" id="submitBtn" class="order-summary__submit">
                            ‚ú® ƒê·∫∑t H√†ng
                        </button>
                        
                        <p class="order-summary__terms">
                            B·∫±ng vi·ªác ƒë·∫∑t h√†ng, b·∫°n ƒë·ªìng √Ω v·ªõi <a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a>
                        </p>
                    </div>
                </div>
            </div>
        </form>
        
        <% } %>
    </div>
</div>

<script src="/js/main.js"></script>
<script>
// Pass EJS data to external JS
window.checkoutData = {
    subtotal: <%= cart.subtotal %>,
    shippingFee: <%= cart.subtotal >= 500000 ? 0 : 30000 %>,
    validVouchers: {
        'GIAM10': { type: 'percent', value: 10, maxDiscount: 100000, minOrder: 200000 },
        'GIAM20': { type: 'percent', value: 20, maxDiscount: 200000, minOrder: 500000 },
        'FREESHIP': { type: 'fixed', value: <%= cart.subtotal >= 500000 ? 0 : 30000 %>, minOrder: 0 },
        'VIP50K': { type: 'fixed', value: 50000, minOrder: 300000 }
    }
};
</script>
<script src="/js/checkout.js"></script>

<%- include('../partials/footer') %>

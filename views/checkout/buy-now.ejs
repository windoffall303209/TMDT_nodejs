<%- include('../partials/header') %>

<div class="checkout-page" style="padding: 40px 0; background: #f5f5f5; min-height: 80vh;">
    <div class="container">
        <h1 style="margin: 0 0 30px 0; font-size: 28px; font-weight: 700; color: #333;">‚ö° Mua Ngay</h1>
        
        <form action="/orders/buy-now/create" method="POST" id="buyNowForm">
            <input type="hidden" name="product_id" value="<%= product.id %>">
            <input type="hidden" name="quantity" value="1">
            
            <div style="display: grid; grid-template-columns: 1fr 400px; gap: 30px;">
                
                <!-- Left Column - Address & Payment -->
                <div>
                    <!-- Product Info -->
                    <div style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #333;">üì¶ S·∫£n ph·∫©m</h3>
                        <div style="display: flex; gap: 15px;">
                            <div style="width: 100px; height: 100px; border-radius: 10px; overflow: hidden; background: #f5f5f5;">
                                <% if (product.images && product.images.length > 0) { %>
                                    <img src="<%= product.images[0].image_url %>" alt="<%= product.name %>" style="width: 100%; height: 100%; object-fit: cover;">
                                <% } else { %>
                                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 40px;">üëï</div>
                                <% } %>
                            </div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; color: #333;"><%= product.name %></h4>
                                <p style="color: #d32f2f; font-weight: 700; font-size: 18px; margin: 0;">
                                    <%= (product.final_price || product.price).toLocaleString('vi-VN') %>ƒë
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Shipping Address -->
                    <div style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #333;">üìç ƒê·ªãa Ch·ªâ Giao H√†ng</h3>
                        
                        <% if (addresses && addresses.length > 0) { %>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <% addresses.forEach((addr, index) => { %>
                                    <label style="display: flex; align-items: flex-start; gap: 12px; padding: 15px; border: 2px solid <%= addr.is_default ? '#667eea' : '#e0e0e0' %>; border-radius: 10px; cursor: pointer;">
                                        <input type="radio" name="address_id" value="<%= addr.id %>" <%= addr.is_default ? 'checked' : '' %> required style="margin-top: 3px;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #333;"><%= addr.full_name %> - <%= addr.phone %></div>
                                            <div style="color: #666; margin-top: 5px; font-size: 14px;">
                                                <%= addr.address_line %><%= addr.ward ? ', ' + addr.ward : '' %><%= addr.district ? ', ' + addr.district : '' %>, <%= addr.city %>
                                            </div>
                                            <% if (addr.is_default) { %>
                                                <span style="display: inline-block; margin-top: 8px; padding: 3px 10px; background: #e8f5e9; color: #2e7d32; font-size: 12px; border-radius: 4px;">M·∫∑c ƒë·ªãnh</span>
                                            <% } %>
                                        </div>
                                    </label>
                                <% }) %>
                            </div>
                        <% } else { %>
                            <p style="color: #666; margin-bottom: 15px;">B·∫°n ch∆∞a c√≥ ƒë·ªãa ch·ªâ giao h√†ng.</p>
                        <% } %>
                        
                        <!-- New Address Form -->
                        <div id="newAddressForm" style="<%= (!addresses || addresses.length === 0) ? 'display: block;' : 'display: none;' %> margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 10px;">
                            <h4 style="margin: 0 0 15px 0; font-size: 16px; color: #333;">Th√™m ƒë·ªãa ch·ªâ m·ªõi</h4>
                            <div style="display: grid; gap: 15px; grid-template-columns: 1fr 1fr;">
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">H·ªç t√™n*</label>
                                    <input type="text" id="newFullName" placeholder="Nguy·ªÖn VƒÉn A" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">S·ªë ƒëi·ªán tho·∫°i*</label>
                                    <input type="tel" id="newPhone" placeholder="0901234567" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            <div style="margin-top: 15px;">
                                <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">ƒê·ªãa ch·ªâ chi ti·∫øt*</label>
                                <input type="text" id="newAddressLine" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="display: grid; gap: 15px; grid-template-columns: 1fr 1fr 1fr; margin-top: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">Ph∆∞·ªùng/X√£</label>
                                    <input type="text" id="newWard" placeholder="Ph∆∞·ªùng 1" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">Qu·∫≠n/Huy·ªán</label>
                                    <input type="text" id="newDistrict" placeholder="Qu·∫≠n 1" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">T·ªânh/Th√†nh ph·ªë*</label>
                                    <input type="text" id="newCity" placeholder="TP. H·ªì Ch√≠ Minh" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            <button type="button" onclick="saveNewAddress()" style="margin-top: 20px; padding: 12px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                L∆∞u ƒë·ªãa ch·ªâ
                            </button>
                        </div>
                        
                        <% if (addresses && addresses.length > 0) { %>
                            <button type="button" onclick="toggleAddressForm()" style="margin-top: 15px; padding: 10px 20px; background: #f0f0f0; color: #333; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                ‚ûï Th√™m ƒë·ªãa ch·ªâ m·ªõi
                            </button>
                        <% } %>
                    </div>
                    
                    <!-- Payment Method -->
                    <div style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #333;">üí≥ Ph∆∞∆°ng Th·ª©c Thanh To√°n</h3>
                        
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid #667eea; border-radius: 10px; cursor: pointer;">
                                <input type="radio" name="payment_method" value="cod" checked required>
                                <span style="font-size: 24px;">üíµ</span>
                                <div>
                                    <div style="font-weight: 600; color: #333;">Thanh to√°n khi nh·∫≠n h√†ng (COD)</div>
                                    <div style="color: #666; font-size: 13px;">Thanh to√°n ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</div>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer;">
                                <input type="radio" name="payment_method" value="vnpay">
                                <span style="font-size: 24px;">üè¶</span>
                                <div>
                                    <div style="font-weight: 600; color: #333;">VNPay</div>
                                    <div style="color: #666; font-size: 13px;">Thanh to√°n qua ng√¢n h√†ng, ATM, Visa/Master</div>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer;">
                                <input type="radio" name="payment_method" value="momo">
                                <span style="font-size: 24px;">üì±</span>
                                <div>
                                    <div style="font-weight: 600; color: #333;">V√≠ MoMo</div>
                                    <div style="color: #666; font-size: 13px;">Qu√©t QR thanh to√°n qua MoMo</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #333;">üìù Ghi ch√∫</h3>
                        <textarea name="notes" rows="3" placeholder="Ghi ch√∫ cho ƒë∆°n h√†ng..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                    </div>
                </div>
                
                <!-- Right Column - Summary -->
                <div>
                    <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 20px;">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #333;">üìã T·ªïng ƒë∆°n h√†ng</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #666;">Gi√° s·∫£n ph·∫©m:</span>
                                <span style="font-weight: 500;"><%= (product.final_price || product.price).toLocaleString('vi-VN') %>ƒë</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #666;">Ph√≠ v·∫≠n chuy·ªÉn:</span>
                                <% const price = product.final_price || product.price; %>
                                <% const shippingFee = price >= 500000 ? 0 : 30000; %>
                                <span style="font-weight: 500; color: <%= shippingFee === 0 ? '#2e7d32' : '#333' %>;"><%= shippingFee === 0 ? 'Mi·ªÖn ph√≠' : '30.000ƒë' %></span>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; padding-top: 15px; border-top: 2px solid #333;">
                            <span style="font-size: 18px; font-weight: 600;">T·ªïng c·ªông:</span>
                            <span style="font-size: 22px; font-weight: 700; color: #d32f2f;"><%= (price + shippingFee).toLocaleString('vi-VN') %>ƒë</span>
                        </div>
                        
                        <button type="submit" id="submitBtn" style="width: 100%; margin-top: 25px; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: 700; cursor: pointer;">
                            ‚ö° ƒê·∫∑t H√†ng Ngay
                        </button>
                        
                        <a href="/products/<%= product.slug %>" style="display: block; text-align: center; margin-top: 15px; color: #667eea; text-decoration: none; font-weight: 500;">
                            ‚Üê Quay l·∫°i s·∫£n ph·∫©m
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="/js/main.js"></script>
<script>
function toggleAddressForm() {
    const form = document.getElementById('newAddressForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

async function saveNewAddress() {
    const fullName = document.getElementById('newFullName').value;
    const phone = document.getElementById('newPhone').value;
    const addressLine = document.getElementById('newAddressLine').value;
    const ward = document.getElementById('newWard').value;
    const district = document.getElementById('newDistrict').value;
    const city = document.getElementById('newCity').value;
    
    if (!fullName || !phone || !addressLine || !city) {
        alert('‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
        return;
    }
    
    try {
        const response = await fetch('/auth/address', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({
                full_name: fullName,
                phone: phone,
                address_line: addressLine,
                ward: ward,
                district: district,
                city: city,
                is_default: true
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ ƒê√£ l∆∞u ƒë·ªãa ch·ªâ!');
            location.reload();
        } else {
            alert('‚ùå ' + (data.message || 'C√≥ l·ªói x·∫£y ra'));
        }
    } catch (error) {
        alert('‚ùå C√≥ l·ªói x·∫£y ra');
    }
}

// Payment method selection styling
document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.querySelectorAll('input[name="payment_method"]').forEach(r => {
            r.closest('label').style.borderColor = '#e0e0e0';
        });
        this.closest('label').style.borderColor = '#667eea';
    });
});

// Address selection styling
document.querySelectorAll('input[name="address_id"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.querySelectorAll('input[name="address_id"]').forEach(r => {
            r.closest('label').style.borderColor = '#e0e0e0';
        });
        this.closest('label').style.borderColor = '#667eea';
    });
});

// Form validation
document.getElementById('buyNowForm')?.addEventListener('submit', function(e) {
    const addressSelected = document.querySelector('input[name="address_id"]:checked');
    if (!addressSelected) {
        e.preventDefault();
        alert('‚ùå Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng');
        return;
    }
    
    const btn = document.getElementById('submitBtn');
    btn.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';
    btn.disabled = true;
});
</script>

<%- include('../partials/footer') %>

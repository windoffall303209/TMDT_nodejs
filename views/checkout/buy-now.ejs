<%- include('../partials/header') %>

<!-- Load Checkout CSS -->
<link rel="stylesheet" href="/css/checkout.css">

<div class="checkout-page">
    <div class="container">
        <h1 class="checkout-page__title">‚ö° Mua Ngay</h1>
        
        <form action="/orders/buy-now/create" method="POST" id="buyNowForm">
            <input type="hidden" name="product_id" value="<%= product.id %>">
            <input type="hidden" name="quantity" value="1">
            
            <div class="checkout-grid">
                
                <!-- Left Column - Product, Address & Payment -->
                <div>
                    <!-- Product Info -->
                    <div class="checkout-section">
                        <h3 class="checkout-section__title">üì¶ S·∫£n ph·∫©m</h3>
                        <div class="order-summary__item" style="border-bottom: none; padding: 0;">
                            <div class="order-summary__item-image" style="width: 100px; height: 100px;">
                                <% if (product.images && product.images.length > 0) { %>
                                    <img src="<%= product.images[0].image_url %>" alt="<%= product.name %>">
                                <% } else { %>
                                    <div class="order-summary__item-placeholder" style="font-size: 40px;">üëï</div>
                                <% } %>
                            </div>
                            <div class="order-summary__item-info">
                                <div class="order-summary__item-name" style="font-size: 16px;"><%= product.name %></div>
                                <div style="margin-top: 8px;">
                                    <% if (product.price !== product.final_price && product.final_price) { %>
                                        <span style="color: #999; text-decoration: line-through; font-size: 14px;"><%= product.price.toLocaleString('vi-VN') %>ƒë</span>
                                    <% } %>
                                    <strong style="color: #d32f2f; font-size: 18px;"><%= (product.final_price || product.price).toLocaleString('vi-VN') %>ƒë</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Shipping Address -->
                    <div class="checkout-section">
                        <h3 class="checkout-section__title">üìç ƒê·ªãa Ch·ªâ Giao H√†ng</h3>
                        
                        <% if (addresses && addresses.length > 0) { %>
                            <div class="address-list">
                                <% addresses.forEach((addr, index) => { %>
                                    <label class="address-card <%= addr.is_default ? 'address-card--selected' : '' %>">
                                        <input type="radio" name="address_id" value="<%= addr.id %>" <%= addr.is_default ? 'checked' : '' %> required class="address-card__radio">
                                        <div class="address-card__content">
                                            <div class="address-card__name"><%= addr.full_name %> - <%= addr.phone %></div>
                                            <div class="address-card__detail">
                                                <%= addr.address_line %><%= addr.ward ? ', ' + addr.ward : '' %><%= addr.district ? ', ' + addr.district : '' %>, <%= addr.city %>
                                            </div>
                                            <% if (addr.is_default) { %>
                                                <span class="address-card__badge">M·∫∑c ƒë·ªãnh</span>
                                            <% } %>
                                        </div>
                                    </label>
                                <% }) %>
                            </div>
                            <button type="button" onclick="toggleAddressForm()" class="address-add-btn">
                                ‚ûï Th√™m ƒë·ªãa ch·ªâ m·ªõi
                            </button>
                        <% } else { %>
                            <p class="checkout-section__text">B·∫°n ch∆∞a c√≥ ƒë·ªãa ch·ªâ giao h√†ng. Vui l√≤ng th√™m ƒë·ªãa ch·ªâ m·ªõi.</p>
                        <% } %>
                        
                        <!-- New Address Form -->
                        <div id="newAddressForm" class="address-form" style="display: <%= (!addresses || addresses.length === 0) ? 'block' : 'none' %>;">
                            <h4 class="address-form__title">Th√™m ƒë·ªãa ch·ªâ m·ªõi</h4>
                            <div class="address-form__grid">
                                <div>
                                    <label class="address-form__label">H·ªç t√™n*</label>
                                    <input type="text" id="newFullName" placeholder="Nguy·ªÖn VƒÉn A" class="address-form__input">
                                </div>
                                <div>
                                    <label class="address-form__label">S·ªë ƒëi·ªán tho·∫°i*</label>
                                    <input type="tel" id="newPhone" placeholder="0901234567" class="address-form__input">
                                </div>
                            </div>
                            <div class="address-form__field">
                                <label class="address-form__label">ƒê·ªãa ch·ªâ chi ti·∫øt*</label>
                                <input type="text" id="newAddressLine" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng..." class="address-form__input">
                            </div>
                            <div class="address-form__grid-3">
                                <div>
                                    <label class="address-form__label">Ph∆∞·ªùng/X√£</label>
                                    <input type="text" id="newWard" placeholder="Ph∆∞·ªùng 1" class="address-form__input">
                                </div>
                                <div>
                                    <label class="address-form__label">Qu·∫≠n/Huy·ªán</label>
                                    <input type="text" id="newDistrict" placeholder="Qu·∫≠n 1" class="address-form__input">
                                </div>
                                <div>
                                    <label class="address-form__label">T·ªânh/Th√†nh ph·ªë*</label>
                                    <input type="text" id="newCity" placeholder="TP. H·ªì Ch√≠ Minh" class="address-form__input">
                                </div>
                            </div>
                            <button type="button" onclick="saveNewAddress()" class="address-form__submit">
                                L∆∞u ƒë·ªãa ch·ªâ
                            </button>
                        </div>
                    </div>
                    
                    <!-- Payment Method -->
                    <div class="checkout-section">
                        <h3 class="checkout-section__title">üí≥ Ph∆∞∆°ng Th·ª©c Thanh To√°n</h3>
                        
                        <div class="payment-list">
                            <label class="payment-option payment-option--selected">
                                <input type="radio" name="payment_method" value="cod" checked required>
                                <div class="payment-option__content">
                                    <span class="payment-option__icon">üíµ</span>
                                    <div>
                                        <div class="payment-option__name">Thanh to√°n khi nh·∫≠n h√†ng (COD)</div>
                                        <div class="payment-option__desc">Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="vnpay">
                                <div class="payment-option__content">
                                    <span class="payment-option__icon">üè¶</span>
                                    <div>
                                        <div class="payment-option__name">VNPay</div>
                                        <div class="payment-option__desc">Thanh to√°n qua ng√¢n h√†ng, th·∫ª ATM, Visa/Master</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="momo">
                                <div class="payment-option__content">
                                    <span class="payment-option__icon">üì±</span>
                                    <div>
                                        <div class="payment-option__name">V√≠ MoMo</div>
                                        <div class="payment-option__desc">Qu√©t m√£ QR thanh to√°n qua v√≠ MoMo</div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="checkout-section">
                        <h3 class="checkout-notes__title">üìù Ghi ch√∫</h3>
                        <textarea name="notes" rows="3" placeholder="Ghi ch√∫ cho ƒë∆°n h√†ng (kh√¥ng b·∫Øt bu·ªôc)..." class="checkout-notes__textarea"></textarea>
                    </div>
                </div>
                
                <!-- Right Column - Order Summary -->
                <div>
                    <div class="order-summary">
                        <h3 class="order-summary__title">üìã T·ªïng ƒë∆°n h√†ng</h3>
                        
                        <div class="order-summary__prices">
                            <% const productPrice = product.final_price || product.price; %>
                            <% const shippingFee = productPrice >= 500000 ? 0 : 30000; %>
                            
                            <div class="order-summary__row">
                                <span class="order-summary__label">Gi√° s·∫£n ph·∫©m:</span>
                                <span class="order-summary__value"><%= productPrice.toLocaleString('vi-VN') %>ƒë</span>
                            </div>
                            <div class="order-summary__row">
                                <span class="order-summary__label">Ph√≠ v·∫≠n chuy·ªÉn:</span>
                                <span id="shippingDisplay" class="order-summary__value <%= shippingFee === 0 ? 'order-summary__value--free' : '' %>"><%= shippingFee === 0 ? 'Mi·ªÖn ph√≠' : shippingFee.toLocaleString('vi-VN') + 'ƒë' %></span>
                            </div>
                            
                            <% if (productPrice < 500000) { %>
                                <div class="order-summary__shipping-tip">
                                    <p>üí° Mua th√™m <%= (500000 - productPrice).toLocaleString('vi-VN') %>ƒë ƒë·ªÉ ƒë∆∞·ª£c mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn!</p>
                                </div>
                            <% } %>
                            
                            <!-- Voucher Section -->
                            <div class="voucher-section">
                                <div class="voucher-section__input-group">
                                    <input type="text" id="voucherCode" name="voucher_code" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°" class="voucher-section__input">
                                    <button type="button" onclick="applyVoucher()" class="voucher-section__btn">√Åp d·ª•ng</button>
                                </div>
                                <div id="voucherMessage" class="voucher-section__message"></div>
                            </div>
                            
                            <!-- Discount Row -->
                            <div id="discountRow" class="discount-row">
                                <span class="discount-row__label">Gi·∫£m gi√°:</span>
                                <span id="discountAmount" class="discount-row__value">-0ƒë</span>
                            </div>
                            
                            <!-- Hidden fields -->
                            <input type="hidden" name="shipping_fee" id="shippingFeeInput" value="<%= shippingFee %>">
                            <input type="hidden" name="discount_amount" id="discountInput" value="0">
                            <input type="hidden" name="subtotal" value="<%= productPrice %>">
                            
                            <div class="order-summary__total">
                                <span class="order-summary__total-label">T·ªïng c·ªông:</span>
                                <span id="totalAmount" class="order-summary__total-value"><%= (productPrice + shippingFee).toLocaleString('vi-VN') %>ƒë</span>
                            </div>
                        </div>
                        
                        <button type="submit" id="submitBtn" class="order-summary__submit">
                            ‚ö° ƒê·∫∑t H√†ng Ngay
                        </button>
                        
                        <a href="/products/<%= product.slug %>" style="display: block; text-align: center; margin-top: 15px; color: #667eea; text-decoration: none; font-weight: 500;">
                            ‚Üê Quay l·∫°i s·∫£n ph·∫©m
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="/js/main.js"></script>
<script>
// Pass product data to JS
window.buyNowData = {
    subtotal: <%= productPrice %>,
    shippingFee: <%= shippingFee %>,
    validVouchers: {
        'GIAM10': { type: 'percent', value: 10, maxDiscount: 100000, minOrder: 200000 },
        'GIAM20': { type: 'percent', value: 20, maxDiscount: 200000, minOrder: 500000 },
        'FREESHIP': { type: 'fixed', value: <%= shippingFee %>, minOrder: 0 },
        'VIP50K': { type: 'fixed', value: 50000, minOrder: 300000 }
    }
};
</script>
<script src="/js/buy-now.js"></script>

<%- include('../partials/footer') %>

<%- include('../partials/admin-header', { currentPage: 'users' }) %>

<div class="admin-page" style="padding: 40px 20px;">
    <div class="container">
        <h1 style="margin-bottom: 40px; color: #333;">üë• Qu·∫£n L√Ω Ng∆∞·ªùi D√πng</h1>
        
        <% if (users && users.length > 0) { %>
            <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #eee;">
                            <th style="padding: 15px; text-align: left;">ID</th>
                            <th style="padding: 15px; text-align: left;">H·ªç T√™n</th>
                            <th style="padding: 15px; text-align: left;">Email</th>
                            <th style="padding: 15px; text-align: center;">Vai Tr√≤</th>
                            <th style="padding: 15px; text-align: center;">Tr·∫°ng Th√°i</th>
                            <th style="padding: 15px; text-align: center;">Ng√†y T·∫°o</th>
                            <th style="padding: 15px; text-align: center;">Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% users.forEach(u => { %>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 15px;"><%= u.id %></td>
                                <td style="padding: 15px;"><strong><%= u.full_name %></strong></td>
                                <td style="padding: 15px;"><%= u.email %></td>
                                <td style="padding: 15px; text-align: center;">
                                    <span style="padding: 4px 10px; border-radius: 12px; font-size: 12px; background: <%= u.role === 'admin' ? '#e3f2fd' : '#f5f5f5' %>; color: <%= u.role === 'admin' ? '#1976d2' : '#666' %>;">
                                        <%= u.role === 'admin' ? 'Admin' : 'Kh√°ch h√†ng' %>
                                    </span>
                                </td>
                                <td style="padding: 15px; text-align: center;">
                                    <% const isActive = Boolean(u.is_active); %>
                                    <span style="padding: 4px 10px; border-radius: 12px; font-size: 12px; background: <%= isActive ? '#e8f5e9' : '#ffebee' %>; color: <%= isActive ? '#2e7d32' : '#c62828' %>;">
                                        <%= isActive ? 'Ho·∫°t ƒë·ªông' : 'B·ªã kh√≥a' %>
                                    </span>
                                </td>
                                <td style="padding: 15px; text-align: center;"><%= new Date(u.created_at).toLocaleDateString('vi-VN') %></td>
                                <td style="padding: 15px; text-align: center;">
                                    <% if (u.role !== 'admin') { %>
                                        <button onclick="toggleUserStatus('<%= u.id %>', <%= isActive %>)" style="padding: 6px 12px; font-size: 12px; background: <%= isActive ? '#ffebee' : '#e8f5e9' %>; color: <%= isActive ? '#c62828' : '#2e7d32' %>; border: none; border-radius: 4px; cursor: pointer;">
                                            <%= isActive ? 'üîí Kh√≥a' : 'üîì M·ªü kh√≥a' %>
                                        </button>
                                    <% } else { %>
                                        <span style="color: #999; font-size: 12px;">-</span>
                                    <% } %>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        <% } else { %>
            <div style="text-align: center; padding: 60px; background: white; border-radius: 12px;">
                <span style="font-size: 64px;">üë§</span>
                <h3 style="margin: 20px 0 10px 0; color: #333;">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o</h3>
            </div>
        <% } %>
    </div>
</div>

<!-- Toast Notification Container -->
<div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10000;"></div>

<!-- Confirm Modal Dialog -->
<div id="confirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; padding: 30px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: modalFadeIn 0.2s ease;">
        <h3 id="confirmTitle" style="margin: 0 0 15px 0; font-size: 20px; color: #333;">X√°c nh·∫≠n</h3>
        <p id="confirmMessage" style="margin: 0 0 25px 0; color: #666; font-size: 15px;">B·∫°n c√≥ ch·∫Øc mu·ªën th·ª±c hi·ªán?</p>
        <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="confirmYes" style="padding: 12px 30px; background: #f44336; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">Kh√≥a</button>
            <button id="confirmNo" style="padding: 12px 30px; background: #f5f5f5; color: #333; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">H·ªßy</button>
        </div>
    </div>
</div>

<script>
// Toast notification
function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    const bgColor = type === 'success' ? 'linear-gradient(135deg, #4caf50, #45a049)' : 
                    type === 'error' ? 'linear-gradient(135deg, #f44336, #d32f2f)' : 
                    'linear-gradient(135deg, #2196f3, #1976d2)';
    const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
    
    toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; background: ${bgColor}; color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); margin-bottom: 10px; min-width: 280px; animation: slideInRight 0.3s ease;">
            <span style="font-size: 20px;">${icon}</span>
            <span style="font-size: 14px; font-weight: 500;">${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: white; font-size: 18px; cursor: pointer;">√ó</button>
        </div>
    `;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

// Custom confirm modal
function showConfirm(message, title = 'X√°c nh·∫≠n', yesText = 'X√°c nh·∫≠n', yesColor = '#f44336') {
    return new Promise((resolve) => {
        const modal = document.getElementById('confirmModal');
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmYes').textContent = yesText;
        document.getElementById('confirmYes').style.background = yesColor;
        modal.style.display = 'flex';
        
        document.getElementById('confirmYes').onclick = () => {
            modal.style.display = 'none';
            resolve(true);
        };
        document.getElementById('confirmNo').onclick = () => {
            modal.style.display = 'none';
            resolve(false);
        };
    });
}

async function toggleUserStatus(userId, currentStatus) {
    const action = currentStatus ? 'kh√≥a' : 'm·ªü kh√≥a';
    const yesColor = currentStatus ? '#f44336' : '#4caf50';
    const confirmed = await showConfirm(
        `B·∫°n c√≥ ch·∫Øc mu·ªën ${action} ng∆∞·ªùi d√πng n√†y?`, 
        currentStatus ? 'X√°c nh·∫≠n Kh√≥a ng∆∞·ªùi d√πng' : 'X√°c nh·∫≠n M·ªü kh√≥a ng∆∞·ªùi d√πng',
        currentStatus ? 'Kh√≥a' : 'M·ªü kh√≥a',
        yesColor
    );
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/admin/users/${userId}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ is_active: String(!currentStatus) })
        });
        if (response.ok) {
            showToast(`ƒê√£ ${action} ng∆∞·ªùi d√πng th√†nh c√¥ng!`, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            const result = await response.json();
            showToast('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i'), 'error');
        }
    } catch (error) {
        showToast('L·ªói: ' + error.message, 'error');
    }
}
</script>

<style>
@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
@keyframes modalFadeIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}
</style>

<%- include('../partials/admin-footer') %>


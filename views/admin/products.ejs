<%- include('../partials/admin-header', { currentPage: 'products' }) %>

<div class="admin-page">
    <div class="container">
        <!-- Page Header -->
        <div class="admin-page-header">
            <div class="admin-page-header__left">
                <h1>Quản Lý Sản Phẩm</h1>
                <p><%= products ? products.length : 0 %> sản phẩm</p>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card stat-card--blue">
                <h3 class="stat-card__label">Tổng sản phẩm</h3>
                <p class="stat-card__value"><%= products ? products.length : 0 %></p>
            </div>
            <div class="stat-card stat-card--green">
                <h3 class="stat-card__label">Còn hàng</h3>
                <p class="stat-card__value"><%= products ? products.filter(p => p.stock_quantity > 0).length : 0 %></p>
            </div>
            <div class="stat-card stat-card--pink">
                <h3 class="stat-card__label">Hết hàng</h3>
                <p class="stat-card__value"><%= products ? products.filter(p => p.stock_quantity <= 0).length : 0 %></p>
            </div>
            <div class="stat-card stat-card--purple">
                <h3 class="stat-card__label">Danh mục</h3>
                <p class="stat-card__value"><%= categories ? categories.length : 0 %></p>
            </div>
        </div>

        <!-- Add Product Form -->
        <div class="admin-section admin-section--collapsible">
            <h3 class="admin-section__title admin-section__title--toggle" onclick="toggleSection(this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Thêm Sản Phẩm Mới
                <svg class="admin-section__chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </h3>
            <form action="/admin/products" method="POST" enctype="multipart/form-data" class="admin-form admin-section__content">
                <div class="admin-form__row">
                    <div class="admin-form__group">
                        <label class="admin-form__label">Tên sản phẩm <span>*</span></label>
                        <input type="text" name="name" required class="admin-form__input" placeholder="VD: Áo thun nam basic">
                    </div>
                    <div class="admin-form__group">
                        <label class="admin-form__label">Slug</label>
                        <input type="text" name="slug" class="admin-form__input" placeholder="Tự động tạo nếu để trống">
                    </div>
                </div>
                <div class="admin-form__row">
                    <div class="admin-form__group">
                        <label class="admin-form__label">Danh mục <span>*</span></label>
                        <select name="category_id" required class="admin-form__select">
                            <option value="">-- Chọn danh mục --</option>
                            <% if (categories && categories.length > 0) { %>
                                <% categories.forEach(cat => { %>
                                    <option value="<%= cat.id %>"><%= cat.name %></option>
                                <% }) %>
                            <% } %>
                        </select>
                    </div>
                    <div class="admin-form__group">
                        <label class="admin-form__label">Giá (VNĐ) <span>*</span></label>
                        <input type="number" name="price" required class="admin-form__input" placeholder="VD: 350000">
                    </div>
                    <div class="admin-form__group">
                        <label class="admin-form__label">Số lượng</label>
                        <input type="number" name="stock_quantity" value="0" class="admin-form__input" placeholder="VD: 100">
                    </div>
                    <div class="admin-form__group">
                        <label class="admin-form__label">SKU</label>
                        <input type="text" name="sku" class="admin-form__input" placeholder="VD: ATN-001">
                    </div>
                </div>
                <div class="admin-form__group">
                    <label class="admin-form__label">Mô tả</label>
                    <textarea name="description" rows="3" class="admin-form__textarea" placeholder="Mô tả chi tiết sản phẩm..."></textarea>
                </div>
                <div class="admin-form__group">
                    <label class="admin-form__label">Hình ảnh</label>
                    <input type="file" name="images" multiple accept="image/*" class="admin-form__input">
                    <small class="admin-form__hint">Có thể chọn nhiều ảnh cùng lúc</small>
                </div>
                <div class="admin-form__actions">
                    <button type="submit" class="admin-btn admin-btn--primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Thêm Sản Phẩm
                    </button>
                </div>
            </form>
        </div>

        <!-- Products Table -->
        <% if (products && products.length > 0) { %>
            <div class="admin-table-wrapper">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Sản Phẩm</th>
                            <th>Danh Mục</th>
                            <th class="text-right">Giá</th>
                            <th class="text-center">Kho</th>
                            <th class="text-center">Trạng Thái</th>
                            <th class="text-center">Thao Tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% products.forEach(product => { %>
                            <tr>
                                <td><%= product.id %></td>
                                <td>
                                    <div class="product-info">
                                        <div class="product-info__image">
                                            <% if (product.primary_image) { %>
                                                <img src="<%= product.primary_image %>" alt="<%= product.name %>">
                                            <% } else { %>
                                                <div class="product-info__placeholder">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                                        <polyline points="21 15 16 10 5 21"/>
                                                    </svg>
                                                </div>
                                            <% } %>
                                        </div>
                                        <div class="product-info__details">
                                            <span class="product-info__name"><%= product.name %></span>
                                            <% if (product.sku) { %>
                                                <span class="product-info__sku">SKU: <%= product.sku %></span>
                                            <% } %>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="product-category"><%= product.category_name || 'Chưa phân loại' %></span>
                                </td>
                                <td class="text-right">
                                    <span class="admin-table__price"><%= product.price.toLocaleString('vi-VN') %>đ</span>
                                </td>
                                <td class="text-center">
                                    <% if (product.stock_quantity > 10) { %>
                                        <span class="stock-badge stock-badge--success"><%= product.stock_quantity %></span>
                                    <% } else if (product.stock_quantity > 0) { %>
                                        <span class="stock-badge stock-badge--warning"><%= product.stock_quantity %></span>
                                    <% } else { %>
                                        <span class="stock-badge stock-badge--danger">Hết</span>
                                    <% } %>
                                </td>
                                <td class="text-center">
                                    <% if (product.is_active !== false) { %>
                                        <span class="admin-table__badge admin-table__badge--delivered">Hiển thị</span>
                                    <% } else { %>
                                        <span class="admin-table__badge admin-table__badge--cancelled">Ẩn</span>
                                    <% } %>
                                </td>
                                <td class="text-center">
                                    <div class="admin-actions-group">
                                        <button onclick="openImageModal(<%= product.id %>, '<%= product.name.replace(/'/g, "\\'") %>')" class="admin-btn admin-btn--image" title="Quản lý ảnh">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                                <polyline points="21 15 16 10 5 21"/>
                                            </svg>
                                        </button>
                                        <button onclick="openEditModal(<%= product.id %>, '<%= product.name.replace(/'/g, "\\'") %>', <%= product.category_id || 'null' %>, <%= product.price %>, <%= product.stock_quantity %>, '<%= (product.description || '').replace(/'/g, "\\'").replace(/\n/g, '\\n') %>')" class="admin-btn admin-btn--edit" title="Sửa">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                            </svg>
                                        </button>
                                        <button onclick="deleteProduct(<%= product.id %>)" class="admin-btn admin-btn--delete" title="Xóa">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"/>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        <% } else { %>
            <div class="admin-empty">
                <div class="admin-empty__icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                </div>
                <h3 class="admin-empty__title">Chưa có sản phẩm nào</h3>
                <p class="admin-empty__text">Thêm sản phẩm đầu tiên để bắt đầu kinh doanh.</p>
            </div>
        <% } %>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="admin-modal">
    <div class="admin-modal__content">
        <div class="admin-modal__header">
            <h3 class="admin-modal__title">Sửa Sản Phẩm</h3>
            <button class="admin-modal__close" onclick="closeEditModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <form id="editForm" class="admin-form">
            <input type="hidden" id="editProductId">
            <div class="admin-form__group">
                <label class="admin-form__label">Tên sản phẩm <span>*</span></label>
                <input type="text" id="editName" required class="admin-form__input">
            </div>
            <div class="admin-form__row">
                <div class="admin-form__group">
                    <label class="admin-form__label">Danh mục <span>*</span></label>
                    <select id="editCategoryId" required class="admin-form__select">
                        <% if (categories && categories.length > 0) { %>
                            <% categories.forEach(cat => { %>
                                <option value="<%= cat.id %>"><%= cat.name %></option>
                            <% }) %>
                        <% } %>
                    </select>
                </div>
                <div class="admin-form__group">
                    <label class="admin-form__label">Giá (VNĐ) <span>*</span></label>
                    <input type="number" id="editPrice" required class="admin-form__input">
                </div>
            </div>
            <div class="admin-form__group">
                <label class="admin-form__label">Số lượng</label>
                <input type="number" id="editStock" value="0" class="admin-form__input">
            </div>
            <div class="admin-form__group">
                <label class="admin-form__label">Mô tả</label>
                <textarea id="editDescription" rows="3" class="admin-form__textarea"></textarea>
            </div>
            <div class="admin-modal__buttons">
                <button type="button" onclick="closeEditModal()" class="admin-btn admin-btn--ghost">Hủy</button>
                <button type="submit" class="admin-btn admin-btn--primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Lưu Thay Đổi
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Image Management Modal -->
<div id="imageModal" class="admin-modal">
    <div class="admin-modal__content" style="max-width: 700px;">
        <div class="admin-modal__header">
            <h3 class="admin-modal__title">Quản Lý Ảnh: <span id="imageModalProductName"></span></h3>
            <button class="admin-modal__close" onclick="closeImageModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <input type="hidden" id="imageModalProductId">

        <!-- Current Images -->
        <div class="image-section">
            <h4 class="image-section__title">Ảnh hiện tại</h4>
            <div id="imagesGrid" class="images-grid">
                <p class="images-grid__loading">Đang tải...</p>
            </div>
        </div>

        <!-- Add New Image -->
        <div class="image-section">
            <h4 class="image-section__title">Thêm ảnh mới</h4>
            <form id="addImageForm" enctype="multipart/form-data" class="image-upload">
                <div class="image-upload__file">
                    <input type="file" id="newImageFile" name="image" accept="image/*" class="admin-form__input">
                    <label class="image-upload__checkbox">
                        <input type="checkbox" id="isPrimaryImage"> Đặt làm ảnh chính
                    </label>
                </div>
                <button type="submit" class="admin-btn admin-btn--primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Tải lên
                </button>
            </form>
            <div class="image-upload__divider">hoặc</div>
            <div class="image-upload__url">
                <input type="text" id="newImageUrl" placeholder="https://example.com/image.jpg" class="admin-form__input">
                <button onclick="addImageByUrl()" class="admin-btn admin-btn--primary">Thêm URL</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer"></div>

<!-- Confirm Modal -->
<div id="confirmModal">
    <div class="confirm-modal__content">
        <div class="confirm-modal__icon confirm-modal__icon--danger">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
        </div>
        <div class="confirm-modal__text">
            <h3 id="confirmTitle">Xóa Sản Phẩm</h3>
            <p id="confirmMessage">Bạn có chắc muốn xóa sản phẩm này? Hành động không thể hoàn tác.</p>
        </div>
        <div class="confirm-modal__buttons">
            <button id="confirmNo" class="admin-btn admin-btn--ghost">Hủy</button>
            <button id="confirmYes" class="admin-btn admin-btn--danger">Xóa</button>
        </div>
    </div>
</div>

<style>
/* Page Header */
.admin-page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
}

.admin-page-header__left h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--admin-text-primary);
    margin: 0 0 4px 0;
}

.admin-page-header__left p {
    font-size: 14px;
    color: var(--admin-text-secondary);
    margin: 0;
}

/* Admin Form Row */
.admin-form__row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.admin-form__group {
    display: flex;
    flex-direction: column;
}

.admin-form__hint {
    font-size: 12px;
    color: var(--admin-text-muted);
    margin-top: 6px;
}

.admin-form__actions {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--admin-border);
}

/* Product Info */
.product-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.product-info__image {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
}

.product-info__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.product-info__placeholder {
    width: 100%;
    height: 100%;
    background: var(--admin-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--admin-text-muted);
}

.product-info__details {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.product-info__name {
    font-weight: 500;
    color: var(--admin-text-primary);
}

.product-info__sku {
    font-size: 12px;
    color: var(--admin-text-secondary);
}

/* Product Category */
.product-category {
    font-size: 13px;
    color: var(--admin-text-secondary);
    background: var(--admin-bg);
    padding: 4px 10px;
    border-radius: 4px;
}

/* Stock Badge */
.stock-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
}

.stock-badge--success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--admin-success);
}

.stock-badge--warning {
    background: rgba(245, 158, 11, 0.1);
    color: #b45309;
}

.stock-badge--danger {
    background: rgba(239, 68, 68, 0.1);
    color: var(--admin-danger);
}

/* Actions Group */
.admin-actions-group {
    display: flex;
    gap: 8px;
    justify-content: center;
}

/* Modal Header */
.admin-modal__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--admin-border);
    margin-bottom: 20px;
}

.admin-modal__close {
    width: 36px;
    height: 36px;
    border: none;
    background: var(--admin-bg);
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--admin-text-secondary);
    transition: all 0.2s;
}

.admin-modal__close:hover {
    background: var(--admin-border);
    color: var(--admin-text-primary);
}

.admin-modal__buttons {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--admin-border);
}

/* Image Section */
.image-section {
    margin-bottom: 24px;
}

.image-section__title {
    font-size: 14px;
    font-weight: 600;
    color: var(--admin-text-primary);
    margin: 0 0 12px 0;
}

.images-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
}

.images-grid__loading {
    grid-column: 1 / -1;
    text-align: center;
    color: var(--admin-text-muted);
    padding: 20px;
}

.images-grid__item {
    position: relative;
    aspect-ratio: 1;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid var(--admin-border);
}

.images-grid__item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.images-grid__item--primary {
    border-color: var(--admin-accent);
}

.images-grid__item-badge {
    position: absolute;
    top: 4px;
    left: 4px;
    background: var(--admin-accent);
    color: white;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
}

.images-grid__item-delete {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--admin-danger);
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
}

.images-grid__item:hover .images-grid__item-delete {
    opacity: 1;
}

/* Image Upload */
.image-upload {
    display: flex;
    gap: 12px;
    align-items: flex-end;
}

.image-upload__file {
    flex: 1;
}

.image-upload__checkbox {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
    font-size: 13px;
    color: var(--admin-text-secondary);
    cursor: pointer;
}

.image-upload__divider {
    text-align: center;
    color: var(--admin-text-muted);
    font-size: 13px;
    margin: 16px 0;
    position: relative;
}

.image-upload__divider::before,
.image-upload__divider::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 40%;
    height: 1px;
    background: var(--admin-border);
}

.image-upload__divider::before {
    left: 0;
}

.image-upload__divider::after {
    right: 0;
}

.image-upload__url {
    display: flex;
    gap: 12px;
}

.image-upload__url .admin-form__input {
    flex: 1;
}

/* Confirm Modal Icon */
.confirm-modal__icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
}

.confirm-modal__icon--danger {
    background: rgba(239, 68, 68, 0.1);
    color: var(--admin-danger);
}

.confirm-modal__text {
    text-align: center;
    margin-bottom: 24px;
}

.confirm-modal__text h3 {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 8px 0;
    color: var(--admin-text-primary);
}

.confirm-modal__text p {
    font-size: 14px;
    color: var(--admin-text-secondary);
    margin: 0;
}

/* Admin Button Ghost */
.admin-btn--ghost {
    background: transparent;
    color: var(--admin-text-secondary);
    border: 1px solid var(--admin-border);
}

.admin-btn--ghost:hover {
    background: var(--admin-bg);
    color: var(--admin-text-primary);
}

/* Admin Button Danger */
.admin-btn--danger {
    background: var(--admin-danger);
    color: white;
}

.admin-btn--danger:hover {
    background: #dc2626;
    color: white;
}

/* Responsive */
@media (max-width: 768px) {
    .admin-form__row {
        grid-template-columns: 1fr;
    }

    .images-grid {
        grid-template-columns: repeat(3, 1fr);
    }

    .image-upload {
        flex-direction: column;
    }

    .image-upload__url {
        flex-direction: column;
    }
}

/* Collapsible Section */
.admin-section--collapsible .admin-section__content {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
    padding-top: 0;
    padding-bottom: 0;
}

.admin-section--collapsible.is-open .admin-section__content {
    max-height: 2000px;
    opacity: 1;
    padding-top: 20px;
}

.admin-section__title--toggle {
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: color 0.2s;
}

.admin-section__title--toggle:hover {
    color: var(--admin-primary);
}

.admin-section__chevron {
    margin-left: auto;
    transition: transform 0.3s ease;
}

.admin-section--collapsible.is-open .admin-section__chevron {
    transform: rotate(180deg);
}
</style>

<script>
// Toggle collapsible section
function toggleSection(titleElement) {
    const section = titleElement.closest('.admin-section--collapsible');
    section.classList.toggle('is-open');
}
</script>
<script src="/js/admin/products.js"></script>

<%- include('../partials/admin-footer') %>

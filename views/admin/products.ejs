<%- include('../partials/admin-header', { currentPage: 'products' }) %>

<div class="admin-page">
    <div class="container">
        <h1 class="admin-page__title">üì¶ Qu·∫£n L√Ω S·∫£n Ph·∫©m</h1>
        
        <!-- Add Product Form -->
        <div class="admin-section">
            <h3 class="admin-section__title">‚ûï Th√™m S·∫£n Ph·∫©m M·ªõi</h3>
            <form action="/admin/products" method="POST" enctype="multipart/form-data">
                <div class="admin-form__grid">
                    <div>
                        <label class="admin-form__label">T√™n s·∫£n ph·∫©m*</label>
                        <input type="text" name="name" required class="admin-form__input">
                    </div>
                    <div>
                        <label class="admin-form__label">Slug</label>
                        <input type="text" name="slug" placeholder="auto-generated" class="admin-form__input">
                    </div>
                    <div>
                        <label class="admin-form__label">Danh m·ª•c*</label>
                        <select name="category_id" required class="admin-form__select">
                            <% if (categories && categories.length > 0) { %>
                                <% categories.forEach(cat => { %>
                                    <option value="<%= cat.id %>"><%= cat.name %></option>
                                <% }) %>
                            <% } else { %>
                                <option value="">Ch∆∞a c√≥ danh m·ª•c</option>
                            <% } %>
                        </select>
                    </div>
                    <div>
                        <label class="admin-form__label">Gi√°*</label>
                        <input type="number" name="price" required class="admin-form__input">
                    </div>
                    <div>
                        <label class="admin-form__label">S·ªë l∆∞·ª£ng</label>
                        <input type="number" name="stock_quantity" value="0" class="admin-form__input">
                    </div>
                    <div>
                        <label class="admin-form__label">SKU</label>
                        <input type="text" name="sku" class="admin-form__input">
                    </div>
                </div>
                <div class="admin-form__field">
                    <label class="admin-form__label">M√¥ t·∫£</label>
                    <textarea name="description" rows="3" class="admin-form__textarea"></textarea>
                </div>
                <div class="admin-form__field">
                    <label class="admin-form__label">H√¨nh ·∫£nh</label>
                    <input type="file" name="images" multiple accept="image/*" class="admin-form__input">
                </div>
                <button type="submit" class="admin-form__submit">Th√™m S·∫£n Ph·∫©m</button>
            </form>
        </div>
        
        <!-- Products List -->
        <% if (products && products.length > 0) { %>
            <div class="admin-table-wrapper">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>T√™n</th>
                            <th>Danh M·ª•c</th>
                            <th class="text-right">Gi√°</th>
                            <th class="text-center">Kho</th>
                            <th class="text-center">Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% products.forEach(product => { %>
                            <tr>
                                <td><%= product.id %></td>
                                <td><strong><%= product.name %></strong></td>
                                <td><%= product.category_name || 'N/A' %></td>
                                <td class="text-right admin-table__price"><%= product.price.toLocaleString('vi-VN') %>ƒë</td>
                                <td class="text-center"><%= product.stock_quantity %></td>
                                <td class="text-center">
                                    <button onclick="openImageModal(<%= product.id %>, '<%= product.name.replace(/'/g, "\\'") %>')" class="admin-btn admin-btn--image">üñºÔ∏è ·∫¢nh</button>
                                    <button onclick="openEditModal(<%= product.id %>, '<%= product.name.replace(/'/g, "\\'") %>', <%= product.category_id || 'null' %>, <%= product.price %>, <%= product.stock_quantity %>, '<%= (product.description || '').replace(/'/g, "\\'").replace(/\n/g, '\\n') %>')" class="admin-btn admin-btn--edit">S·ª≠a</button>
                                    <button onclick="deleteProduct(<%= product.id %>)" class="admin-btn admin-btn--delete">X√≥a</button>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        <% } else { %>
            <div class="admin-empty">
                <span class="admin-empty__icon">üì¶</span>
                <h3 class="admin-empty__title">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</h3>
            </div>
        <% } %>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="admin-modal">
    <div class="admin-modal__content">
        <h3 class="admin-modal__title">‚úèÔ∏è S·ª≠a S·∫£n Ph·∫©m</h3>
        <form id="editForm">
            <input type="hidden" id="editProductId">
            <div class="admin-form__field">
                <label class="admin-form__label">T√™n s·∫£n ph·∫©m*</label>
                <input type="text" id="editName" required class="admin-form__input">
            </div>
            <div class="admin-form__field">
                <label class="admin-form__label">Danh m·ª•c*</label>
                <select id="editCategoryId" required class="admin-form__select">
                    <% if (categories && categories.length > 0) { %>
                        <% categories.forEach(cat => { %>
                            <option value="<%= cat.id %>"><%= cat.name %></option>
                        <% }) %>
                    <% } %>
                </select>
            </div>
            <div class="admin-form__field">
                <label class="admin-form__label">Gi√°*</label>
                <input type="number" id="editPrice" required class="admin-form__input">
            </div>
            <div class="admin-form__field">
                <label class="admin-form__label">S·ªë l∆∞·ª£ng</label>
                <input type="number" id="editStock" value="0" class="admin-form__input">
            </div>
            <div class="admin-form__field">
                <label class="admin-form__label">M√¥ t·∫£</label>
                <textarea id="editDescription" rows="3" class="admin-form__textarea"></textarea>
            </div>
            <div class="admin-modal__buttons">
                <button type="submit" class="admin-form__submit">L∆∞u Thay ƒê·ªïi</button>
                <button type="button" onclick="closeEditModal()" class="admin-btn admin-btn--add">H·ªßy</button>
            </div>
        </form>
    </div>
</div>

<!-- Image Management Modal -->
<div id="imageModal" class="admin-modal">
    <div class="admin-modal__content" style="max-width: 700px;">
        <h3 class="admin-modal__title">üñºÔ∏è Qu·∫£n L√Ω ·∫¢nh: <span id="imageModalProductName"></span></h3>
        <input type="hidden" id="imageModalProductId">
        
        <!-- Current Images -->
        <div id="currentImages">
            <h4 class="admin-form__label">·∫¢nh hi·ªán t·∫°i:</h4>
            <div id="imagesGrid" class="admin-form__grid">
                <p style="color: #999;">ƒêang t·∫£i...</p>
            </div>
        </div>
        
        <!-- Add New Image -->
        <div class="admin-form__field" style="border-top: 1px solid #eee; padding-top: 20px;">
            <h4 class="admin-form__label">Th√™m ·∫£nh m·ªõi:</h4>
            <form id="addImageForm" enctype="multipart/form-data" style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex: 1;">
                    <input type="file" id="newImageFile" name="image" accept="image/*" class="admin-form__input">
                </div>
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="isPrimaryImage"> ·∫¢nh ch√≠nh
                </label>
                <button type="submit" class="admin-form__submit" style="margin-top: 0;">Th√™m</button>
            </form>
            <p style="margin-top: 10px; color: #999; font-size: 13px;">Ho·∫∑c nh·∫≠p URL ·∫£nh:</p>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="newImageUrl" placeholder="https://example.com/image.jpg" class="admin-form__input" style="flex: 1;">
                <button onclick="addImageByUrl()" class="admin-btn admin-btn--image" style="padding: 10px 20px; background: #4caf50;">Th√™m URL</button>
            </div>
        </div>
        
        <button onclick="closeImageModal()" class="admin-btn admin-btn--add" style="margin-top: 20px; width: 100%; padding: 12px;">ƒê√≥ng</button>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer"></div>

<!-- Confirm Modal -->
<div id="confirmModal">
    <div class="confirm-modal__content">
        <h3 id="confirmTitle" class="confirm-modal__title">X√°c nh·∫≠n</h3>
        <p id="confirmMessage" class="confirm-modal__message">B·∫°n c√≥ ch·∫Øc mu·ªën th·ª±c hi·ªán?</p>
        <div class="confirm-modal__buttons">
            <button id="confirmYes" class="confirm-modal__btn confirm-modal__btn--yes">X√°c nh·∫≠n</button>
            <button id="confirmNo" class="confirm-modal__btn confirm-modal__btn--no">H·ªßy</button>
        </div>
    </div>
</div>

<script src="/js/admin/products.js"></script>

<%- include('../partials/admin-footer') %>

<%- include('../partials/admin-header', { currentPage: 'vouchers' }) %>

<div class="admin-page">
    <div class="container">
        <!-- Page Header -->
        <div class="admin-page-header">
            <div class="admin-page-header__left">
                <h1>Quản Lý Voucher</h1>
                <p><%= vouchers ? vouchers.length : 0 %> mã giảm giá</p>
            </div>
            <!-- <div class="admin-page-header__actions">
                <button class="admin-btn admin-btn--primary" onclick="openAddVoucherModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Thêm Voucher
                </button>
            </div> -->
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card stat-card--purple">
                <h3 class="stat-card__label">Tổng voucher</h3>
                <p class="stat-card__value"><%= vouchers ? vouchers.length : 0 %></p>
            </div>
            <div class="stat-card stat-card--green">
                <h3 class="stat-card__label">Đang hoạt động</h3>
                <p class="stat-card__value"><%= vouchers ? vouchers.filter(v => v.is_active).length : 0 %></p>
            </div>
            <div class="stat-card stat-card--pink">
                <h3 class="stat-card__label">Hết hạn</h3>
                <p class="stat-card__value"><%= vouchers ? vouchers.filter(v => !v.is_active).length : 0 %></p>
            </div>
            <div class="stat-card stat-card--blue">
                <h3 class="stat-card__label">Giảm theo %</h3>
                <p class="stat-card__value"><%= vouchers ? vouchers.filter(v => v.type === 'percentage').length : 0 %></p>
            </div>
        </div>

        <!-- Add Voucher Form -->
        <div class="admin-section admin-section--collapsible">
            <h3 class="admin-section__title admin-section__title--toggle" onclick="toggleSection(this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Thêm Voucher Mới
                <svg class="admin-section__chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </h3>
            <form action="/admin/vouchers" method="POST" class="admin-form admin-section__content">
                <div class="admin-form__row">
                    <div class="admin-form__group">
                        <label class="admin-form__label">Mã voucher <span>*</span></label>
                        <input type="text" name="code" required class="admin-form__input" placeholder="VD: WELCOME10" style="text-transform: uppercase;">
                    </div>
                    <div class="admin-form__group">
                        <label class="admin-form__label">Tên voucher <span>*</span></label>
                        <input type="text" name="name" required class="admin-form__input" placeholder="VD: Chào mừng thành viên mới">
                    </div>
                    <div class="admin-form__group">
                        <label class="admin-form__label">Loại giảm giá</label>
                        <select name="type" class="admin-form__select" id="voucherType" onchange="toggleMaxDiscount()">
                            <option value="percentage">Phần trăm (%)</option>
                            <option value="fixed">Số tiền cố định (VNĐ)</option>
                        </select>
                    </div>
                </div>
                <div class="admin-form__row">
                    <div class="admin-form__group">
                        <label class="admin-form__label">Giá trị <span>*</span></label>
                        <input type="number" name="value" required step="0.01" class="admin-form__input" placeholder="VD: 10 (cho 10%)">
                    </div>
                    <div class="admin-form__group">
                        <label class="admin-form__label">Đơn hàng tối thiểu</label>
                        <input type="number" name="min_order_amount" class="admin-form__input" placeholder="VD: 100000" value="0">
                    </div>
                    <div class="admin-form__group" id="maxDiscountGroup">
                        <label class="admin-form__label">Giảm tối đa</label>
                        <input type="number" name="max_discount_amount" class="admin-form__input" placeholder="VD: 50000">
                    </div>
                </div>
                <div class="admin-form__row">
                    <div class="admin-form__group">
                        <label class="admin-form__label">Số lượt sử dụng</label>
                        <input type="number" name="usage_limit" class="admin-form__input" placeholder="Để trống = không giới hạn">
                    </div>
                    <div class="admin-form__group">
                        <label class="admin-form__label">Giới hạn/người</label>
                        <input type="number" name="user_limit" class="admin-form__input" placeholder="Mặc định: 1" value="1">
                    </div>
                </div>
                <div class="admin-form__row">
                    <div class="admin-form__group">
                        <label class="admin-form__label">Ngày bắt đầu <span>*</span></label>
                        <input type="datetime-local" name="start_date" required class="admin-form__input">
                    </div>
                    <div class="admin-form__group">
                        <label class="admin-form__label">Ngày kết thúc <span>*</span></label>
                        <input type="datetime-local" name="end_date" required class="admin-form__input">
                    </div>
                    <div class="admin-form__group">
                        <label class="admin-form__label">Trạng thái</label>
                        <div class="admin-form__checkbox">
                            <input type="checkbox" name="is_active" id="isActive" checked>
                            <label for="isActive">Kích hoạt ngay</label>
                        </div>
                    </div>
                </div>
                <div class="admin-form__group">
                    <label class="admin-form__label">Mô tả</label>
                    <textarea name="description" class="admin-form__textarea" placeholder="Mô tả chi tiết về voucher..."></textarea>
                </div>
                <div class="admin-form__actions">
                    <button type="submit" class="admin-btn admin-btn--primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Tạo Voucher
                    </button>
                </div>
            </form>
        </div>

        <!-- Vouchers Table -->
        <% if (vouchers && vouchers.length > 0) { %>
            <div class="admin-table-wrapper">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Mã Voucher</th>
                            <th>Tên</th>
                            <th class="text-center">Loại</th>
                            <th class="text-center">Giá Trị</th>
                            <th class="text-center">Đã Dùng</th>
                            <th class="text-center">Thời Gian</th>
                            <th class="text-center">Trạng Thái</th>
                            <th class="text-center">Thao Tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% vouchers.forEach(voucher => { %>
                            <tr>
                                <td>
                                    <span class="voucher-code"><%= voucher.code %></span>
                                </td>
                                <td>
                                    <div class="voucher-info">
                                        <strong class="voucher-info__name"><%= voucher.name %></strong>
                                        <% if (voucher.description) { %>
                                            <span class="voucher-info__desc"><%= voucher.description %></span>
                                        <% } %>
                                        <% if (voucher.min_order_amount > 0) { %>
                                            <span class="voucher-info__min">Đơn tối thiểu: <%= voucher.min_order_amount.toLocaleString('vi-VN') %>đ</span>
                                        <% } %>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="admin-table__badge <%= voucher.type === 'percentage' ? 'admin-table__badge--processing' : 'admin-table__badge--shipped' %>">
                                        <%= voucher.type === 'percentage' ? 'Phần trăm' : 'Cố định' %>
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="voucher-value">
                                        <%= voucher.type === 'percentage' ? '-' + voucher.value + '%' : '-' + (voucher.value || 0).toLocaleString('vi-VN') + 'đ' %>
                                    </span>
                                    <% if (voucher.type === 'percentage' && voucher.max_discount_amount) { %>
                                        <br><small class="text-muted">Tối đa: <%= voucher.max_discount_amount.toLocaleString('vi-VN') %>đ</small>
                                    <% } %>
                                </td>
                                <td class="text-center">
                                    <span class="voucher-usage">
                                        <%= voucher.used_count || 0 %><% if (voucher.usage_limit) { %>/<%= voucher.usage_limit %><% } %>
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="voucher-dates">
                                        <% if (voucher.start_date) { %>
                                            <span class="voucher-dates__start"><%= new Date(voucher.start_date).toLocaleDateString('vi-VN') %></span>
                                        <% } %>
                                        <% if (voucher.start_date && voucher.end_date) { %>
                                            <span class="voucher-dates__separator">→</span>
                                        <% } %>
                                        <% if (voucher.end_date) { %>
                                            <span class="voucher-dates__end"><%= new Date(voucher.end_date).toLocaleDateString('vi-VN') %></span>
                                        <% } %>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <%
                                        const now = new Date();
                                        const isExpired = voucher.end_date && new Date(voucher.end_date) < now;
                                        const isActive = voucher.is_active && !isExpired;
                                    %>
                                    <% if (isActive) { %>
                                        <span class="admin-table__badge admin-table__badge--delivered">Hoạt động</span>
                                    <% } else if (isExpired) { %>
                                        <span class="admin-table__badge admin-table__badge--cancelled">Hết hạn</span>
                                    <% } else { %>
                                        <span class="admin-table__badge admin-table__badge--pending">Tạm dừng</span>
                                    <% } %>
                                </td>
                                <td class="text-center">
                                    <div class="admin-actions-group">
                                        <button onclick="toggleVoucherStatus(<%= voucher.id %>, <%= !voucher.is_active %>)"
                                                class="admin-btn <%= voucher.is_active ? 'admin-btn--warning' : 'admin-btn--success' %>"
                                                title="<%= voucher.is_active ? 'Tạm dừng' : 'Kích hoạt' %>">
                                            <% if (voucher.is_active) { %>
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>
                                                </svg>
                                            <% } else { %>
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                                </svg>
                                            <% } %>
                                        </button>
                                        <button onclick="deleteVoucher(<%= voucher.id %>)" class="admin-btn admin-btn--delete" title="Xóa">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"/>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        <% } else { %>
            <div class="admin-empty">
                <div class="admin-empty__icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                        <line x1="7" y1="7" x2="7.01" y2="7"/>
                    </svg>
                </div>
                <h3 class="admin-empty__title">Chưa có voucher nào</h3>
                <p class="admin-empty__text">Tạo voucher đầu tiên để thu hút khách hàng.</p>
            </div>
        <% } %>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer"></div>

<!-- Confirm Modal -->
<div id="confirmModal">
    <div class="confirm-modal__content">
        <div class="confirm-modal__icon confirm-modal__icon--danger">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
        </div>
        <div class="confirm-modal__text">
            <h3 id="confirmTitle">Xác nhận xóa</h3>
            <p id="confirmMessage">Bạn có chắc muốn xóa voucher này?</p>
        </div>
        <div class="confirm-modal__buttons">
            <button id="confirmNo" class="admin-btn admin-btn--ghost">Hủy</button>
            <button id="confirmYes" class="admin-btn admin-btn--danger">Xóa</button>
        </div>
    </div>
</div>

<style>
/* Voucher Code */
.voucher-code {
    font-family: 'Courier New', monospace;
    font-weight: 700;
    font-size: 14px;
    color: var(--admin-primary);
    background: rgba(79, 70, 229, 0.1);
    padding: 4px 8px;
    border-radius: 4px;
    letter-spacing: 1px;
}

/* Voucher Info */
.voucher-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.voucher-info__name {
    color: var(--admin-text-primary);
}

.voucher-info__desc {
    font-size: 12px;
    color: var(--admin-text-secondary);
}

.voucher-info__min {
    font-size: 11px;
    color: var(--admin-text-muted);
    font-style: italic;
}

/* Voucher Value */
.voucher-value {
    font-weight: 600;
    color: var(--admin-danger);
    font-size: 15px;
}

/* Voucher Usage */
.voucher-usage {
    font-weight: 500;
    color: var(--admin-text-primary);
}

/* Voucher Dates */
.voucher-dates {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-size: 13px;
    color: var(--admin-text-secondary);
}

.voucher-dates__separator {
    color: var(--admin-text-muted);
}

/* Checkbox Style */
.admin-form__checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 0;
}

.admin-form__checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.admin-form__checkbox label {
    cursor: pointer;
    color: var(--admin-text-primary);
}

/* Textarea */
.admin-form__textarea {
    width: 100%;
    min-height: 80px;
    padding: 12px;
    border: 1px solid var(--admin-border);
    border-radius: 8px;
    font-size: 14px;
    resize: vertical;
    font-family: inherit;
}

.admin-form__textarea:focus {
    outline: none;
    border-color: var(--admin-primary);
}

/* Text Muted */
.text-muted {
    color: var(--admin-text-muted);
}

/* Warning Button */
.admin-btn--warning {
    background: #f59e0b;
    color: white;
}

.admin-btn--warning:hover {
    background: #d97706;
}

/* Success Button */
.admin-btn--success {
    background: #10b981;
    color: white;
}

.admin-btn--success:hover {
    background: #059669;
}

/* Page Header */
.admin-page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
}

.admin-page-header__left h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--admin-text-primary);
    margin: 0 0 4px 0;
}

.admin-page-header__left p {
    font-size: 14px;
    color: var(--admin-text-secondary);
    margin: 0;
}

/* Admin Form Row */
.admin-form__row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.admin-form__group {
    display: flex;
    flex-direction: column;
}

.admin-form__actions {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--admin-border);
}

/* Confirm Modal */
.confirm-modal__icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
}

.confirm-modal__icon--danger {
    background: rgba(239, 68, 68, 0.1);
    color: var(--admin-danger);
}

.confirm-modal__text {
    text-align: center;
    margin-bottom: 24px;
}

.confirm-modal__text h3 {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 8px 0;
    color: var(--admin-text-primary);
}

.confirm-modal__text p {
    font-size: 14px;
    color: var(--admin-text-secondary);
    margin: 0;
}

/* Buttons */
.admin-btn--ghost {
    background: transparent;
    color: var(--admin-text-secondary);
    border: 1px solid var(--admin-border);
}

.admin-btn--ghost:hover {
    background: var(--admin-bg);
    color: var(--admin-text-primary);
}

.admin-btn--danger {
    background: var(--admin-danger);
    color: white;
}

.admin-btn--danger:hover {
    background: #dc2626;
}

.admin-actions-group {
    display: flex;
    gap: 8px;
    justify-content: center;
}

/* Collapsible Section */
.admin-section--collapsible .admin-section__content {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
    padding-top: 0;
    padding-bottom: 0;
}

.admin-section--collapsible.is-open .admin-section__content {
    max-height: 2000px;
    opacity: 1;
    padding-top: 20px;
}

.admin-section__title--toggle {
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: color 0.2s;
}

.admin-section__title--toggle:hover {
    color: var(--admin-primary);
}

.admin-section__chevron {
    margin-left: auto;
    transition: transform 0.3s ease;
}

.admin-section--collapsible.is-open .admin-section__chevron {
    transform: rotate(180deg);
}
</style>

<script>
// Toggle max discount visibility based on type
function toggleMaxDiscount() {
    const type = document.getElementById('voucherType').value;
    const maxDiscountGroup = document.getElementById('maxDiscountGroup');
    maxDiscountGroup.style.display = type === 'percentage' ? 'flex' : 'none';
}

// Delete voucher
function deleteVoucher(voucherId) {
    const modal = document.getElementById('confirmModal');
    modal.style.display = 'flex';

    document.getElementById('confirmYes').onclick = async function() {
        try {
            const response = await fetch('/admin/vouchers/' + voucherId, {
                method: 'DELETE'
            });
            const data = await response.json();
            if (data.success) {
                showToast('Đã xóa voucher thành công');
                setTimeout(() => location.reload(), 500);
            } else {
                showToast(data.message || 'Không thể xóa voucher', 'error');
            }
        } catch (error) {
            showToast('Có lỗi xảy ra', 'error');
        }
        modal.style.display = 'none';
    };

    document.getElementById('confirmNo').onclick = function() {
        modal.style.display = 'none';
    };
}

// Toggle voucher status
async function toggleVoucherStatus(voucherId, newStatus) {
    try {
        const response = await fetch('/admin/vouchers/' + voucherId + '/status', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_active: newStatus })
        });
        const data = await response.json();
        if (data.success) {
            showToast(newStatus ? 'Đã kích hoạt voucher' : 'Đã tạm dừng voucher');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(data.message || 'Có lỗi xảy ra', 'error');
        }
    } catch (error) {
        showToast('Có lỗi xảy ra', 'error');
    }
}

// Toast notification
function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast toast--' + type;
    toast.innerHTML = message;
    container.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Open add voucher modal (scroll to form)
function openAddVoucherModal() {
    document.querySelector('.admin-section').scrollIntoView({ behavior: 'smooth' });
}

// Toggle collapsible section
function toggleSection(titleElement) {
    const section = titleElement.closest('.admin-section--collapsible');
    section.classList.toggle('is-open');
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    toggleMaxDiscount();
});
</script>

<%- include('../partials/admin-footer') %>

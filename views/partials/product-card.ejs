<div class="product-card">
    <a href="/products/<%= product.slug %>">
        <div class="product-card__image">
            <%# Sale Badge %>
            <% if (product.sale_type) { %>
                <span class="product-card__badge product-card__badge--sale">
                    <% if (product.sale_type === 'percentage') { %>
                        -<%= product.sale_value %>%
                    <% } else if (product.sale_type === 'fixed') { %>
                        -<%= product.sale_value.toLocaleString('vi-VN') %>đ
                    <% } %>
                </span>
            <% } %>

            <%# New/Out of Stock Badge %>
            <% if (product.stock_quantity === 0) { %>
                <span class="product-card__badge product-card__badge--soldout">Hết hàng</span>
            <% } else if (product.created_at && new Date() - new Date(product.created_at) < 7 * 24 * 60 * 60 * 1000) { %>
                <span class="product-card__badge product-card__badge--new">Mới</span>
            <% } %>

            <%# Primary Image %>
            <% if (product.primary_image) { %>
                <img class="img-primary" src="<%= product.primary_image %>" alt="<%= product.name %>">
            <% } else { %>
                <div class="product-card__image-placeholder">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21,15 16,10 5,21"/>
                    </svg>
                </div>
            <% } %>

            <%# Secondary Image for Hover Effect %>
            <% if (product.secondary_image) { %>
                <img class="img-secondary" src="<%= product.secondary_image %>" alt="<%= product.name %>">
            <% } else if (product.images && product.images.length > 1) { %>
                <img class="img-secondary" src="<%= product.images[1] %>" alt="<%= product.name %>">
            <% } %>

            <%# Quick Add Button %>
            <button class="product-card__quick-add" onclick="addToCart(event, <%= product.id %>)" <% if (product.stock_quantity === 0) { %>disabled<% } %>>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="9" cy="21" r="1"/>
                    <circle cx="20" cy="21" r="1"/>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                </svg>
                <span>Thêm vào giỏ</span>
            </button>
        </div>

        <div class="product-card__info">
            <h3 class="product-card__name"><%= product.name %></h3>

            <%# Rating %>
            <% if (product.average_rating > 0) { %>
                <div class="product-card__rating">
                    <span class="product-card__stars">
                        <% for (let i = 1; i <= 5; i++) { %>
                            <% if (i <= Math.floor(product.average_rating)) { %>★<% } else { %>☆<% } %>
                        <% } %>
                    </span>
                    <span class="product-card__review-count">(<%= product.review_count %>)</span>
                </div>
            <% } %>

            <%# Price %>
            <% if (product.final_price < product.price) { %>
                <p class="product-card__price-original"><%= product.price.toLocaleString('vi-VN') %>đ</p>
                <p class="product-card__price product-card__price--sale"><%= product.final_price.toLocaleString('vi-VN') %>đ</p>
            <% } else { %>
                <p class="product-card__price"><%= product.price.toLocaleString('vi-VN') %>đ</p>
            <% } %>

            <%# Color Variants %>
            <% if (product.variants && product.variants.length > 0) { %>
                <div class="product-card__colors">
                    <% const uniqueColors = [...new Set(product.variants.map(v => v.color))].slice(0, 5); %>
                    <% uniqueColors.forEach(color => { %>
                        <span class="product-card__color-dot" style="background-color: <%= color %>"></span>
                    <% }) %>
                    <% if (product.variants.length > 5) { %>
                        <span class="product-card__color-more">+<%= product.variants.length - 5 %></span>
                    <% } %>
                </div>
            <% } %>
        </div>
    </a>
</div>

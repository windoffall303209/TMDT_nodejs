<%- include('../partials/header') %>

<div class="cart-page" style="padding: 40px 0; background: #f5f5f5; min-height: 80vh;">
    <div class="container">
        <h1 style="margin: 0 0 30px 0; font-size: 28px; font-weight: 700; color: #333;">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h1>
        
        <% if (!cart || !cart.items || cart.items.length === 0) { %>
            <div style="text-align: center; padding: 60px; background: white; border-radius: 12px;">
                <span style="font-size: 64px;">üõí</span>
                <h2 style="margin: 20px 0 10px 0; color: #333;">Gi·ªè h√†ng tr·ªëng</h2>
                <p style="color: #666;">Th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng ƒë·ªÉ mua s·∫Øm</p>
                <a href="/products" style="display: inline-block; margin-top: 20px; padding: 14px 28px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">Ti·∫øp t·ª•c mua s·∫Øm</a>
            </div>
        <% } else { %>
            <div style="display: grid; grid-template-columns: 1fr 350px; gap: 30px;">
                <!-- Cart Items -->
                <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <!-- Select All -->
                    <div style="display: flex; align-items: center; gap: 15px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-weight: 600; color: #333;">Ch·ªçn t·∫•t c·∫£ (<%= cart.items.length %> s·∫£n ph·∫©m)</span>
                        </label>
                    </div>
                    
                    <!-- Items List -->
                    <div id="cartItems">
                        <% cart.items.forEach((item, index) => { %>
                            <div class="cart-item" data-item-id="<%= item.id %>" data-price="<%= item.subtotal %>" style="display: flex; gap: 15px; padding: 20px 0; <%= index < cart.items.length - 1 ? 'border-bottom: 1px solid #f0f0f0;' : '' %>">
                                <!-- Checkbox -->
                                <div style="display: flex; align-items: center;">
                                    <input type="checkbox" class="item-checkbox" value="<%= item.id %>" data-price="<%= item.subtotal %>" onchange="updateSelectedTotal()" style="width: 20px; height: 20px; cursor: pointer;">
                                </div>
                                
                                <!-- Image -->
                                <div style="width: 100px; height: 100px; border-radius: 10px; overflow: hidden; background: #f5f5f5; flex-shrink: 0;">
                                    <% if (item.product_image) { %>
                                        <img src="<%= item.product_image %>" alt="<%= item.product_name %>" style="width: 100%; height: 100%; object-fit: cover;">
                                    <% } else { %>
                                        <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 40px;">üëï</div>
                                    <% } %>
                                </div>
                                
                                <!-- Info -->
                                <div style="flex: 1; min-width: 0;">
                                    <a href="/products/<%= item.product_slug %>" style="font-weight: 600; color: #333; text-decoration: none; display: block; margin-bottom: 8px;">
                                        <%= item.product_name %>
                                    </a>
                                    <% if (item.size || item.color) { %>
                                        <p style="color: #666; font-size: 13px; margin: 0 0 8px 0;">
                                            <% if (item.size) { %>Size: <%= item.size %><% } %>
                                            <% if (item.color) { %> | M√†u: <%= item.color %><% } %>
                                        </p>
                                    <% } %>
                                    <p style="color: #d32f2f; font-weight: 600; margin: 0;"><%= item.unit_price.toLocaleString('vi-VN') %>ƒë</p>
                                </div>
                                
                                <!-- Quantity -->
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <button onclick="updateQuantity(<%= item.id %>, <%= item.quantity - 1 %>)" style="width: 32px; height: 32px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 18px;">‚àí</button>
                                    <input type="number" value="<%= item.quantity %>" min="1" readonly style="width: 50px; text-align: center; border: 1px solid #ddd; border-radius: 6px; padding: 6px;">
                                    <button onclick="updateQuantity(<%= item.id %>, <%= item.quantity + 1 %>)" style="width: 32px; height: 32px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 18px;">+</button>
                                </div>
                                
                                <!-- Subtotal -->
                                <div style="text-align: right; min-width: 120px;">
                                    <p style="color: #d32f2f; font-weight: 700; font-size: 16px; margin: 0;"><%= item.subtotal.toLocaleString('vi-VN') %>ƒë</p>
                                </div>
                                
                                <!-- Remove -->
                                <button onclick="removeItem(<%= item.id %>)" style="width: 36px; height: 36px; border: none; background: #ffebee; color: #c62828; border-radius: 8px; cursor: pointer; font-size: 18px;">√ó</button>
                            </div>
                        <% }) %>
                    </div>
                </div>
                
                <!-- Order Summary -->
                <div style="position: sticky; top: 20px;">
                    <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #333;">üì¶ T·ªïng ƒë∆°n h√†ng</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #666;">S·∫£n ph·∫©m ƒë√£ ch·ªçn:</span>
                                <span id="selectedCount" style="font-weight: 500;">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #666;">T·∫°m t√≠nh:</span>
                                <span id="selectedSubtotal" style="font-weight: 500;">0ƒë</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #666;">Ph√≠ v·∫≠n chuy·ªÉn:</span>
                                <span id="shippingFee" style="font-weight: 500;">30.000ƒë</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; padding-top: 15px; border-top: 2px solid #333;">
                            <span style="font-size: 18px; font-weight: 600;">T·ªïng c·ªông:</span>
                            <span id="selectedTotal" style="font-size: 22px; font-weight: 700; color: #d32f2f;">0ƒë</span>
                        </div>
                        
                        <button onclick="checkoutSelected()" id="checkoutBtn" disabled style="width: 100%; margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; opacity: 0.5;">
                            ‚ú® Thanh to√°n (<span id="checkoutCount">0</span> s·∫£n ph·∫©m)
                        </button>
                        
                        <a href="/products" style="display: block; text-align: center; margin-top: 15px; padding: 14px; background: #f5f5f5; color: #333; text-decoration: none; border-radius: 10px; font-weight: 500;">
                            Ti·∫øp t·ª•c mua s·∫Øm
                        </a>
                    </div>
                </div>
            </div>
        <% } %>
    </div>
</div>

<script src="/js/main.js"></script>
<script>
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.item-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateSelectedTotal();
}

function updateSelectedTotal() {
    const checkboxes = document.querySelectorAll('.item-checkbox:checked');
    let total = 0;
    let count = 0;
    
    checkboxes.forEach(cb => {
        total += parseInt(cb.dataset.price) || 0;
        count++;
    });
    
    const shippingFee = total >= 500000 ? 0 : 30000;
    const grandTotal = total + shippingFee;
    
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('selectedSubtotal').textContent = total.toLocaleString('vi-VN') + 'ƒë';
    document.getElementById('shippingFee').textContent = shippingFee === 0 ? 'Mi·ªÖn ph√≠' : '30.000ƒë';
    document.getElementById('selectedTotal').textContent = grandTotal.toLocaleString('vi-VN') + 'ƒë';
    document.getElementById('checkoutCount').textContent = count;
    
    const checkoutBtn = document.getElementById('checkoutBtn');
    checkoutBtn.disabled = count === 0;
    checkoutBtn.style.opacity = count === 0 ? '0.5' : '1';
    
    // Update select all checkbox
    const allCheckboxes = document.querySelectorAll('.item-checkbox');
    document.getElementById('selectAll').checked = checkboxes.length === allCheckboxes.length && allCheckboxes.length > 0;
}

function checkoutSelected() {
    const checkboxes = document.querySelectorAll('.item-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('‚ùå Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n');
        return;
    }
    
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    
    // Store selected items and redirect to checkout
    sessionStorage.setItem('selectedCartItems', JSON.stringify(selectedIds));
    window.location.href = '/orders/checkout?items=' + selectedIds.join(',');
}

function updateQuantity(itemId, newQuantity) {
    if (newQuantity < 1) {
        removeItem(itemId);
        return;
    }
    
    fetch('/cart/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ cart_item_id: itemId, quantity: newQuantity })
    })
    .then(res => res.json())
    .then(() => location.reload())
    .catch(err => console.error(err));
}

function removeItem(itemId) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) return;
    
    fetch('/cart/remove', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ cart_item_id: itemId })
    })
    .then(res => res.json())
    .then(() => location.reload())
    .catch(err => console.error(err));
}

// Initialize
document.addEventListener('DOMContentLoaded', updateSelectedTotal);
</script>

<%- include('../partials/footer') %>

<%- include('../partials/header') %>

<div class="auth-page">
    <div class="auth-container">
        <h1>Xác nhận Email</h1>

        <div class="verify-email-info">
            <p>Chúng tôi sẽ gửi mã xác nhận 6 số đến email:</p>
            <p class="user-email"><strong><%= user.email %></strong></p>
        </div>

        <div id="alert-container"></div>

        <!-- Step 1: Send verification code -->
        <div id="step-send" class="verify-step">
            <p>Nhấn nút bên dưới để nhận mã xác nhận qua email.</p>
            <button type="button" id="btn-send-code" class="btn btn-primary btn-block">
                Gửi mã xác nhận
            </button>
        </div>

        <!-- Step 2: Enter verification code -->
        <div id="step-verify" class="verify-step" style="display: none;">
            <p>Nhập mã xác nhận 6 số đã được gửi đến email của bạn:</p>

            <form id="verify-form" class="verify-code-form">
                <div class="code-inputs">
                    <input type="text" maxlength="1" class="code-input" data-index="0" autofocus>
                    <input type="text" maxlength="1" class="code-input" data-index="1">
                    <input type="text" maxlength="1" class="code-input" data-index="2">
                    <input type="text" maxlength="1" class="code-input" data-index="3">
                    <input type="text" maxlength="1" class="code-input" data-index="4">
                    <input type="text" maxlength="1" class="code-input" data-index="5">
                </div>
                <input type="hidden" id="full-code" name="code">

                <button type="submit" id="btn-verify" class="btn btn-primary btn-block">
                    Xác nhận
                </button>
            </form>

            <div class="resend-section">
                <p>Không nhận được mã? <button type="button" id="btn-resend" class="btn-link">Gửi lại</button></p>
                <p class="timer-text" id="timer-text"></p>
            </div>
        </div>

        <div class="auth-footer">
            <a href="/auth/profile">Quay lại trang cá nhân</a>
        </div>
    </div>
</div>

<style>
    .verify-email-info {
        text-align: center;
        margin-bottom: 24px;
        padding: 16px;
        background: #f5f5f5;
        border-radius: 8px;
    }

    .user-email {
        color: #1a1a1a;
        font-size: 18px;
        margin-top: 8px;
    }

    .verify-step {
        text-align: center;
    }

    .code-inputs {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 24px 0;
    }

    .code-input {
        width: 50px;
        height: 60px;
        text-align: center;
        font-size: 24px;
        font-weight: 700;
        border: 2px solid #ddd;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .code-input:focus {
        border-color: #000;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    .code-input.filled {
        border-color: #000;
        background: #f8f8f8;
    }

    .code-input.error {
        border-color: #f44336;
        background: #ffebee;
    }

    .resend-section {
        margin-top: 24px;
        color: #666;
    }

    .btn-link {
        background: none;
        border: none;
        color: #000;
        font-weight: 600;
        cursor: pointer;
        text-decoration: underline;
    }

    .btn-link:disabled {
        color: #999;
        cursor: not-allowed;
        text-decoration: none;
    }

    .timer-text {
        font-size: 14px;
        color: #999;
        margin-top: 8px;
    }

    #alert-container .alert {
        padding: 15px 20px;
        margin-bottom: 20px;
        border-radius: 8px;
    }

    #alert-container .alert-success {
        background: #e8f5e9;
        border-left: 4px solid #4caf50;
        color: #2e7d32;
    }

    #alert-container .alert-error {
        background: #ffebee;
        border-left: 4px solid #f44336;
        color: #c62828;
    }

    .btn-block {
        width: 100%;
    }

    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    @media (max-width: 480px) {
        .code-input {
            width: 42px;
            height: 52px;
            font-size: 20px;
        }

        .code-inputs {
            gap: 6px;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const alertContainer = document.getElementById('alert-container');
    const stepSend = document.getElementById('step-send');
    const stepVerify = document.getElementById('step-verify');
    const btnSendCode = document.getElementById('btn-send-code');
    const btnResend = document.getElementById('btn-resend');
    const btnVerify = document.getElementById('btn-verify');
    const verifyForm = document.getElementById('verify-form');
    const codeInputs = document.querySelectorAll('.code-input');
    const fullCodeInput = document.getElementById('full-code');
    const timerText = document.getElementById('timer-text');

    let resendTimer = 0;

    // Show alert
    function showAlert(message, type) {
        alertContainer.innerHTML = `
            <div class="alert alert-${type}">
                ${type === 'success' ? '✅' : '❌'} ${message}
            </div>
        `;
    }

    // Start resend timer
    function startResendTimer() {
        resendTimer = 60;
        btnResend.disabled = true;

        const interval = setInterval(() => {
            resendTimer--;
            timerText.textContent = `Có thể gửi lại sau ${resendTimer}s`;

            if (resendTimer <= 0) {
                clearInterval(interval);
                btnResend.disabled = false;
                timerText.textContent = '';
            }
        }, 1000);
    }

    // Send verification code
    async function sendCode() {
        btnSendCode.disabled = true;
        btnSendCode.textContent = 'Đang gửi...';

        try {
            const response = await fetch('/auth/send-verification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.success) {
                showAlert(data.message, 'success');
                stepSend.style.display = 'none';
                stepVerify.style.display = 'block';
                codeInputs[0].focus();
                startResendTimer();
            } else {
                showAlert(data.message, 'error');
                btnSendCode.disabled = false;
                btnSendCode.textContent = 'Gửi mã xác nhận';
            }
        } catch (error) {
            showAlert('Đã xảy ra lỗi. Vui lòng thử lại.', 'error');
            btnSendCode.disabled = false;
            btnSendCode.textContent = 'Gửi mã xác nhận';
        }
    }

    // Handle code input
    codeInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            const value = e.target.value;

            // Only allow numbers
            e.target.value = value.replace(/[^0-9]/g, '');

            if (e.target.value) {
                e.target.classList.add('filled');
                // Move to next input
                if (index < 5) {
                    codeInputs[index + 1].focus();
                }
            } else {
                e.target.classList.remove('filled');
            }

            // Update full code
            updateFullCode();
        });

        input.addEventListener('keydown', (e) => {
            // Handle backspace
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                codeInputs[index - 1].focus();
            }
        });

        // Handle paste
        input.addEventListener('paste', (e) => {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 6);

            pastedData.split('').forEach((char, i) => {
                if (codeInputs[i]) {
                    codeInputs[i].value = char;
                    codeInputs[i].classList.add('filled');
                }
            });

            updateFullCode();

            if (pastedData.length === 6) {
                codeInputs[5].focus();
            }
        });
    });

    function updateFullCode() {
        const code = Array.from(codeInputs).map(input => input.value).join('');
        fullCodeInput.value = code;
    }

    // Verify code
    verifyForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const code = fullCodeInput.value;

        if (code.length !== 6) {
            showAlert('Vui lòng nhập đầy đủ mã 6 số', 'error');
            return;
        }

        btnVerify.disabled = true;
        btnVerify.textContent = 'Đang xác nhận...';

        try {
            const response = await fetch('/auth/verify-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code })
            });

            const data = await response.json();

            if (data.success) {
                showAlert(data.message, 'success');
                // Redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = '/auth/profile';
                }, 2000);
            } else {
                showAlert(data.message, 'error');
                // Mark inputs as error
                codeInputs.forEach(input => input.classList.add('error'));
                btnVerify.disabled = false;
                btnVerify.textContent = 'Xác nhận';
            }
        } catch (error) {
            showAlert('Đã xảy ra lỗi. Vui lòng thử lại.', 'error');
            btnVerify.disabled = false;
            btnVerify.textContent = 'Xác nhận';
        }
    });

    // Send code button
    btnSendCode.addEventListener('click', sendCode);

    // Resend button
    btnResend.addEventListener('click', async () => {
        btnResend.disabled = true;

        try {
            const response = await fetch('/auth/send-verification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.success) {
                showAlert(data.message, 'success');
                // Clear inputs
                codeInputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('filled', 'error');
                });
                codeInputs[0].focus();
                startResendTimer();
            } else {
                showAlert(data.message, 'error');
                btnResend.disabled = false;
            }
        } catch (error) {
            showAlert('Đã xảy ra lỗi. Vui lòng thử lại.', 'error');
            btnResend.disabled = false;
        }
    });
});
</script>

<%- include('../partials/footer') %>

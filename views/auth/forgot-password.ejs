<%- include('../partials/header') %>

<div class="auth-page">
    <div class="auth-container">
        <h1>Quên mật khẩu</h1>

        <div id="alert-container"></div>

        <!-- Step 1: Enter email -->
        <div id="step-email" class="forgot-step">
            <p>Nhập email đã đăng ký để nhận mã đặt lại mật khẩu.</p>
            <form id="email-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required placeholder="example@email.com">
                </div>
                <button type="submit" id="btn-send-code" class="btn btn-primary btn-block">
                    Gửi mã xác nhận
                </button>
            </form>
        </div>

        <!-- Step 2: Enter verification code -->
        <div id="step-code" class="forgot-step" style="display: none;">
            <p>Nhập mã xác nhận 6 số đã được gửi đến email:</p>
            <p class="user-email" id="display-email"></p>

            <form id="code-form">
                <div class="code-inputs">
                    <input type="text" maxlength="1" class="code-input" data-index="0">
                    <input type="text" maxlength="1" class="code-input" data-index="1">
                    <input type="text" maxlength="1" class="code-input" data-index="2">
                    <input type="text" maxlength="1" class="code-input" data-index="3">
                    <input type="text" maxlength="1" class="code-input" data-index="4">
                    <input type="text" maxlength="1" class="code-input" data-index="5">
                </div>
                <input type="hidden" id="full-code" name="code">

                <button type="submit" id="btn-verify-code" class="btn btn-primary btn-block">
                    Xác nhận mã
                </button>
            </form>

            <div class="resend-section">
                <p>Không nhận được mã? <button type="button" id="btn-resend" class="btn-link">Gửi lại</button></p>
                <p class="timer-text" id="timer-text"></p>
            </div>
        </div>

        <!-- Step 3: Enter new password -->
        <div id="step-password" class="forgot-step" style="display: none;">
            <p>Nhập mật khẩu mới cho tài khoản của bạn.</p>

            <form id="password-form">
                <div class="form-group">
                    <label for="new_password">Mật khẩu mới</label>
                    <input type="password" id="new_password" name="new_password" required minlength="6" placeholder="Tối thiểu 6 ký tự">
                </div>
                <div class="form-group">
                    <label for="confirm_password">Xác nhận mật khẩu</label>
                    <input type="password" id="confirm_password" name="confirm_password" required placeholder="Nhập lại mật khẩu">
                </div>
                <button type="submit" id="btn-reset" class="btn btn-primary btn-block">
                    Đặt lại mật khẩu
                </button>
            </form>
        </div>

        <!-- Step 4: Success -->
        <div id="step-success" class="forgot-step" style="display: none;">
            <div class="success-icon">✅</div>
            <h2>Đặt lại mật khẩu thành công!</h2>
            <p>Bạn có thể đăng nhập với mật khẩu mới.</p>
            <a href="/auth/login" class="btn btn-primary btn-block">Đăng nhập ngay</a>
        </div>

        <div class="auth-footer">
            <p>Đã nhớ mật khẩu? <a href="/auth/login">Đăng nhập</a></p>
        </div>
    </div>
</div>

<style>
    .forgot-step {
        text-align: center;
    }

    .user-email {
        font-weight: 600;
        color: #000;
        margin: 8px 0 20px;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 6px;
    }

    .code-inputs {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 24px 0;
    }

    .code-input {
        width: 50px;
        height: 60px;
        text-align: center;
        font-size: 24px;
        font-weight: 700;
        border: 2px solid #ddd;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .code-input:focus {
        border-color: #000;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    .code-input.filled {
        border-color: #000;
        background: #f8f8f8;
    }

    .code-input.error {
        border-color: #f44336;
        background: #ffebee;
    }

    .resend-section {
        margin-top: 24px;
        color: #666;
    }

    .btn-link {
        background: none;
        border: none;
        color: #000;
        font-weight: 600;
        cursor: pointer;
        text-decoration: underline;
    }

    .btn-link:disabled {
        color: #999;
        cursor: not-allowed;
        text-decoration: none;
    }

    .timer-text {
        font-size: 14px;
        color: #999;
        margin-top: 8px;
    }

    #alert-container .alert {
        padding: 15px 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        text-align: left;
    }

    #alert-container .alert-success {
        background: #e8f5e9;
        border-left: 4px solid #4caf50;
        color: #2e7d32;
    }

    #alert-container .alert-error {
        background: #ffebee;
        border-left: 4px solid #f44336;
        color: #c62828;
    }

    .success-icon {
        font-size: 64px;
        margin-bottom: 20px;
    }

    .btn-block {
        width: 100%;
    }

    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    @media (max-width: 480px) {
        .code-input {
            width: 42px;
            height: 52px;
            font-size: 20px;
        }

        .code-inputs {
            gap: 6px;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const alertContainer = document.getElementById('alert-container');
    const stepEmail = document.getElementById('step-email');
    const stepCode = document.getElementById('step-code');
    const stepPassword = document.getElementById('step-password');
    const stepSuccess = document.getElementById('step-success');

    const emailForm = document.getElementById('email-form');
    const codeForm = document.getElementById('code-form');
    const passwordForm = document.getElementById('password-form');

    const codeInputs = document.querySelectorAll('.code-input');
    const fullCodeInput = document.getElementById('full-code');
    const displayEmail = document.getElementById('display-email');
    const btnResend = document.getElementById('btn-resend');
    const timerText = document.getElementById('timer-text');

    let userEmail = '';
    let resendTimer = 0;

    // Show alert
    function showAlert(message, type) {
        alertContainer.innerHTML = `
            <div class="alert alert-${type}">
                ${type === 'success' ? '✅' : '❌'} ${message}
            </div>
        `;
    }

    function clearAlert() {
        alertContainer.innerHTML = '';
    }

    // Start resend timer
    function startResendTimer() {
        resendTimer = 60;
        btnResend.disabled = true;

        const interval = setInterval(() => {
            resendTimer--;
            timerText.textContent = `Có thể gửi lại sau ${resendTimer}s`;

            if (resendTimer <= 0) {
                clearInterval(interval);
                btnResend.disabled = false;
                timerText.textContent = '';
            }
        }, 1000);
    }

    // Step 1: Send reset code
    emailForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearAlert();

        const emailInput = document.getElementById('email');
        const submitBtn = document.getElementById('btn-send-code');
        userEmail = emailInput.value.trim();

        if (!userEmail) return;

        submitBtn.disabled = true;
        submitBtn.textContent = 'Đang gửi...';

        try {
            const response = await fetch('/auth/forgot-password/send-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: userEmail })
            });

            const data = await response.json();

            if (data.success) {
                showAlert(data.message, 'success');
                displayEmail.textContent = userEmail;
                stepEmail.style.display = 'none';
                stepCode.style.display = 'block';
                codeInputs[0].focus();
                startResendTimer();
            } else {
                showAlert(data.message, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Gửi mã xác nhận';
            }
        } catch (error) {
            showAlert('Đã xảy ra lỗi. Vui lòng thử lại.', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Gửi mã xác nhận';
        }
    });

    // Handle code input
    codeInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            const value = e.target.value;
            e.target.value = value.replace(/[^0-9]/g, '');

            if (e.target.value) {
                e.target.classList.add('filled');
                e.target.classList.remove('error');
                if (index < 5) {
                    codeInputs[index + 1].focus();
                }
            } else {
                e.target.classList.remove('filled');
            }
            updateFullCode();
        });

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                codeInputs[index - 1].focus();
            }
        });

        input.addEventListener('paste', (e) => {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 6);
            pastedData.split('').forEach((char, i) => {
                if (codeInputs[i]) {
                    codeInputs[i].value = char;
                    codeInputs[i].classList.add('filled');
                }
            });
            updateFullCode();
            if (pastedData.length === 6) {
                codeInputs[5].focus();
            }
        });
    });

    function updateFullCode() {
        const code = Array.from(codeInputs).map(input => input.value).join('');
        fullCodeInput.value = code;
    }

    // Step 2: Verify code
    codeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearAlert();

        const code = fullCodeInput.value;
        const submitBtn = document.getElementById('btn-verify-code');

        if (code.length !== 6) {
            showAlert('Vui lòng nhập đầy đủ mã 6 số', 'error');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Đang xác nhận...';

        try {
            const response = await fetch('/auth/forgot-password/verify-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: userEmail, code })
            });

            const data = await response.json();

            if (data.success) {
                clearAlert();
                stepCode.style.display = 'none';
                stepPassword.style.display = 'block';
            } else {
                showAlert(data.message, 'error');
                codeInputs.forEach(input => input.classList.add('error'));
                submitBtn.disabled = false;
                submitBtn.textContent = 'Xác nhận mã';
            }
        } catch (error) {
            showAlert('Đã xảy ra lỗi. Vui lòng thử lại.', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Xác nhận mã';
        }
    });

    // Step 3: Reset password
    passwordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearAlert();

        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        const code = fullCodeInput.value;
        const submitBtn = document.getElementById('btn-reset');

        if (newPassword.length < 6) {
            showAlert('Mật khẩu phải có ít nhất 6 ký tự', 'error');
            return;
        }

        if (newPassword !== confirmPassword) {
            showAlert('Xác nhận mật khẩu không khớp', 'error');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Đang xử lý...';

        try {
            const response = await fetch('/auth/forgot-password/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: userEmail,
                    code,
                    new_password: newPassword,
                    confirm_password: confirmPassword
                })
            });

            const data = await response.json();

            if (data.success) {
                clearAlert();
                stepPassword.style.display = 'none';
                stepSuccess.style.display = 'block';
            } else {
                showAlert(data.message, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Đặt lại mật khẩu';
            }
        } catch (error) {
            showAlert('Đã xảy ra lỗi. Vui lòng thử lại.', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Đặt lại mật khẩu';
        }
    });

    // Resend code
    btnResend.addEventListener('click', async () => {
        clearAlert();
        btnResend.disabled = true;

        try {
            const response = await fetch('/auth/forgot-password/send-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: userEmail })
            });

            const data = await response.json();

            if (data.success) {
                showAlert(data.message, 'success');
                codeInputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('filled', 'error');
                });
                codeInputs[0].focus();
                startResendTimer();
            } else {
                showAlert(data.message, 'error');
                btnResend.disabled = false;
            }
        } catch (error) {
            showAlert('Đã xảy ra lỗi. Vui lòng thử lại.', 'error');
            btnResend.disabled = false;
        }
    });
});
</script>

<%- include('../partials/footer') %>

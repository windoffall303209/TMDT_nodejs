<%- include('../partials/header') %>

<div class="product-detail-page" style="padding: 40px 0;">
    <div class="container">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 60px;">
            <!-- Product Images Gallery -->
            <div class="product-gallery">
                <!-- Main Image -->
                <div style="border-radius: 12px; overflow: hidden; background: #f5f5f5; position: relative;">
                    <% 
                    let mainImage = product.primary_image;
                    if (!mainImage && product.images && product.images.length > 0) {
                        mainImage = product.images[0].image_url;
                    }
                    %>
                    <% if (mainImage) { %>
                        <img src="<%= mainImage %>" 
                             alt="<%= product.name %>" 
                             style="width: 100%; height: 500px; object-fit: cover; transition: opacity 0.3s ease;"
                             id="mainImage"
                             onerror="this.style.display='none'; document.getElementById('fallbackIcon').style.display='flex';">
                        <div id="fallbackIcon" style="display: none; width: 100%; height: 500px; align-items: center; justify-content: center; background: #f5f5f5;">
                            <span style="font-size: 120px;">üëï</span>
                        </div>
                    <% } else { %>
                        <div style="width: 100%; height: 500px; display: flex; align-items: center; justify-content: center;">
                            <span style="font-size: 120px;">üëï</span>
                        </div>
                    <% } %>
                    
                    <% if (product.images && product.images.length > 1) { %>
                        <!-- Navigation Arrows -->
                        <button onclick="prevImage()" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; border-radius: 50%; border: none; background: rgba(255,255,255,0.9); cursor: pointer; font-size: 18px; box-shadow: 0 2px 10px rgba(0,0,0,0.15);">‚ùÆ</button>
                        <button onclick="nextImage()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; border-radius: 50%; border: none; background: rgba(255,255,255,0.9); cursor: pointer; font-size: 18px; box-shadow: 0 2px 10px rgba(0,0,0,0.15);">‚ùØ</button>
                        
                        <!-- Image Counter -->
                        <div style="position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px;">
                            <span id="currentIndex">1</span> / <%= product.images.length %>
                        </div>
                    <% } %>
                </div>
                
                <!-- Thumbnail Gallery -->
                <% if (product.images && product.images.length > 1) { %>
                    <div style="display: flex; gap: 10px; margin-top: 15px; overflow-x: auto; padding: 5px;">
                        <% product.images.forEach((img, index) => { %>
                            <img src="<%= img.image_url %>" 
                                 alt="<%= product.name %> - <%= index + 1 %>"
                                 class="gallery-thumb"
                                 data-index="<%= index %>"
                                 style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 3px solid <%= index === 0 ? '#667eea' : 'transparent' %>; transition: all 0.2s ease; flex-shrink: 0;"
                                 onclick="selectImage(<%= index %>, '<%= img.image_url %>')"
                                 onmouseover="this.style.opacity='0.8'"
                                 onmouseout="this.style.opacity='1'">
                        <% }) %>
                    </div>
                <% } %>
            </div>
            
            <!-- Product Info -->
            <div>
                <h1 style="margin: 0 0 15px 0; font-size: 28px; font-weight: 700; color: #333;"><%= product.name %></h1>
                
                <% if (product.category_name) { %>
                    <p style="margin: 0 0 20px 0; color: #666;">
                        Danh m·ª•c: <a href="/products/category/<%= product.category_slug %>" style="color: #667eea;"><%= product.category_name %></a>
                    </p>
                <% } %>
                
                <div style="margin: 25px 0; padding: 20px; background: linear-gradient(135deg, #fff5f5 0%, #fff 100%); border-radius: 12px; border: 1px solid #ffe0e0;">
                    <% if (product.price !== product.final_price && product.final_price) { %>
                        <p style="margin: 0 0 5px 0; color: #999; text-decoration: line-through; font-size: 18px;">
                            <%= product.price.toLocaleString('vi-VN') %>ƒë
                        </p>
                        <p style="margin: 0; font-size: 36px; font-weight: 700; color: #d32f2f;">
                            <%= product.final_price.toLocaleString('vi-VN') %>ƒë
                        </p>
                        <span style="display: inline-block; margin-top: 10px; padding: 4px 12px; background: #d32f2f; color: white; border-radius: 4px; font-size: 14px;">
                            Gi·∫£m <%= Math.round((1 - product.final_price / product.price) * 100) %>%
                        </span>
                    <% } else { %>
                        <p style="margin: 0; font-size: 36px; font-weight: 700; color: #d32f2f;">
                            <%= (product.final_price || product.price).toLocaleString('vi-VN') %>ƒë
                        </p>
                    <% } %>
                </div>
                
                <% if (product.description) { %>
                    <div style="margin: 30px 0; padding: 25px; background: #f9f9f9; border-radius: 12px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #333;">M√¥ t·∫£ s·∫£n ph·∫©m</h3>
                        <p style="margin: 0; line-height: 1.8; color: #555;"><%= product.description %></p>
                    </div>
                <% } %>
                
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button onclick="addToCart(<%= product.id %>)" class="btn btn-primary" style="flex: 1; padding: 18px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        üõí Th√™m v√†o gi·ªè h√†ng
                    </button>
                    <button onclick="buyNow(<%= product.id %>)" style="flex: 1; padding: 18px; font-size: 18px; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        ‚ö° Mua ngay
                    </button>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #e8f5e9; border-radius: 12px;">
                    <p style="margin: 0; color: #2e7d32; display: flex; align-items: center; gap: 10px;">
                        <span>‚úÖ</span> Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn v·ªõi ƒë∆°n t·ª´ 500.000ƒë
                    </p>
                    <p style="margin: 10px 0 0 0; color: #2e7d32; display: flex; align-items: center; gap: 10px;">
                        <span>üîÑ</span> ƒê·ªïi tr·∫£ mi·ªÖn ph√≠ trong 30 ng√†y
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/js/main.js"></script>
<script>
// Gallery state
let currentImageIndex = 0;
const productImages = [<% if (product.images && product.images.length > 0) { product.images.forEach((img, i) => { %>'<%= img.image_url %>'<% if (i < product.images.length - 1) { %>, <% } }); } %>];

// Select image by index
function selectImage(index, imageUrl) {
    currentImageIndex = index;
    document.getElementById('mainImage').src = imageUrl;
    
    // Update thumbnail borders
    document.querySelectorAll('.gallery-thumb').forEach((thumb, i) => {
        thumb.style.borderColor = i === index ? '#667eea' : 'transparent';
    });
    
    // Update counter
    const counter = document.getElementById('currentIndex');
    if (counter) counter.textContent = index + 1;
}

// Previous image
function prevImage() {
    if (productImages.length === 0) return;
    currentImageIndex = (currentImageIndex - 1 + productImages.length) % productImages.length;
    selectImage(currentImageIndex, productImages[currentImageIndex]);
}

// Next image
function nextImage() {
    if (productImages.length === 0) return;
    currentImageIndex = (currentImageIndex + 1) % productImages.length;
    selectImage(currentImageIndex, productImages[currentImageIndex]);
}

// Buy now function - redirects directly to checkout for this single product
function buyNow(productId) {
    window.location.href = '/orders/buy-now/' + productId;
}
</script>

<%- include('../partials/footer') %>

<%- include('../partials/header') %>

<div class="products-page">
    <div class="container">
        <h1><%= category ? category.name : 'S·∫£n Ph·∫©m' %></h1>
        
        <div class="product-grid" style="margin-top: 40px; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px;">
            <% if (products && products.length > 0) { %>
                <% products.forEach(product => { %>
                    <div class="product-card" style="border: 1px solid #eee; border-radius: 12px; overflow: hidden; transition: transform 0.3s, box-shadow 0.3s; background: white;">
                        <a href="/products/<%= product.slug || product.id %>" style="text-decoration: none; color: inherit;">
                            <div style="height: 300px; overflow: hidden; position: relative; background: #f5f5f5;">
                                <% if (product.primary_image) { %>
                                    <img src="<%= product.primary_image %>" 
                                         alt="<%= product.name %>" 
                                         style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s;"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; background: #f5f5f5;">
                                        <span style="font-size: 64px;">üëï</span>
                                    </div>
                                <% } else { %>
                                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                                        <span style="font-size: 64px;">üëï</span>
                                    </div>
                                <% } %>
                            </div>
                            <div style="padding: 20px;">
                                <h3 style="margin: 0 0 10px 0; font-size: 16px; font-weight: 600; color: #333;"><%= product.name %></h3>
                                <% if (product.price !== product.final_price && product.final_price) { %>
                                    <p style="margin: 0; color: #999; text-decoration: line-through; font-size: 14px;">
                                        <%= product.price.toLocaleString('vi-VN') %>ƒë
                                    </p>
                                <% } %>
                                <p style="margin: 5px 0 0 0; font-size: 20px; font-weight: 700; color: #d32f2f;">
                                    <%= (product.final_price || product.price).toLocaleString('vi-VN') %>ƒë
                                </p>
                            </div>
                        </a>
                        <div style="padding: 0 20px 20px 20px;">
                            <button onclick="addToCart(<%= product.id %>)" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 14px; cursor: pointer;">
                                üõí Th√™m v√†o gi·ªè h√†ng
                            </button>
                        </div>
                    </div>
                <% }) %>
            <% } else { %>
                <p style="text-align: center; padding: 60px 20px; grid-column: 1/-1;">
                    Ch∆∞a c√≥ s·∫£n ph·∫©m trong danh m·ª•c n√†y.
                    <br><br>
                    <a href="/" class="btn btn-primary">V·ªÅ trang ch·ªß</a>
                </p>
            <% } %>
        </div>
    </div>
</div>

<script>
function addToCart(productId) {
    fetch('/cart/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product_id: productId, quantity: 1 })
    })
    .then(res => res.json())
    .then(data => {
        if (data.message) {
            alert('‚úÖ ' + data.message);
            if (typeof updateCartCount === 'function') {
                updateCartCount();
            }
        }
    })
    .catch(err => {
        console.error('Add to cart error:', err);
        alert('C√≥ l·ªói x·∫£y ra khi th√™m v√†o gi·ªè h√†ng');
    });
}
</script>

<%- include('../partials/footer') %>
